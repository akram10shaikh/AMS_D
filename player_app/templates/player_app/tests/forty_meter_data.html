{% extends "player_app/organization/base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Test Results{% endblock %}

{% block extra_head %}
    <style>
        table { width: 90%; margin: 1em auto; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
        th { background-color: #f0f0f0; }
        #searchInput {
            width: 300px;
            padding: 8px;
            font-size: 16px;
        }
        .pagination {
            text-align: center;
            margin: 2em 0;
        }
        .pagination a, .pagination strong {
            display: inline-block;
            padding: 6px 12px;
            margin: 0 2px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            color: #333;
            text-decoration: none;
        }
        .pagination strong {
            background: #e0e0e0;
            font-weight: bold;
        }
        form.search-form {
            text-align: center;
            margin: 2em auto 1em auto;
        }
    </style>
{% endblock %}

{% block content %}
    <h2 style="text-align:center;">{{ test_name }} Test Results</h2>

    <form method="get" class="search-form" aria-label="Search Player Form">
        <input type="text" name="search" id="searchInput" placeholder="Search player name..." value="{{ search_query }}">
        <button type="submit">Search</button>
    </form>

    <p style="text-align:center; margin-top: 0.5em;">
        Total rows: {{ total_results }}
    </p>

    <table id="resultsTable" aria-describedby="results summary">
        <thead>
            <tr>
                <th>No</th>
                <th>Player</th>
                <th>Date</th>
                <th>Phase</th>
                <th>Best</th>
                <th>Notes</th>
                <th>Individual Average</th>
            </tr>
        </thead>
        <tbody>
            {% for result in page_obj %}
            <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td class="player-name">{{ result.player.name }}</td>
                <td>{{ result.date }}</td>
                <td>{{ result.phase }}</td>
                <td>{{ result.best }}</td>
                <td>{{ result.notes|default:"-" }}</td>
                <td>{{ latest_indv_avgs|get_item:result.player.id|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">No results found for {{ test_name }}.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination" style="margin-bottom:100px;">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">&lt; Prev</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <strong>{{ num }}</strong>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next &gt;</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </div>

{% endblock %}
