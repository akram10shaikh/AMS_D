{% extends "player_app/organization/base.html" %}
{% load static %}
{% load player_extras %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
.injury-dashboard-banner {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  background: linear-gradient(95deg, #f9f7ff 69%, #e9f2ff 111%);
  border-radius: 28px;
  box-shadow: 0 12px 46px #7d73e60e, 0 2px 18px #b8c3d322;
  padding: 50px 80px 44px 54px;
  margin-bottom: 40px;
  gap: 56px;
}
.injury-banner-left {
  display: flex; align-items: flex-end;
  gap: 64px; min-width: 400px;
}
.injury-count-card {
  background: #fff7d8;
  border-radius: 22px;
  box-shadow: 0 8px 36px #fbcd3d22;
  min-width: 200px; min-height: 155px;
  text-align: center;
  padding: 32px 28px 17px 28px;
  display: flex; flex-direction: column; justify-content: center;
}
.injury-count {
  font-size: 4.6em;
  font-weight: 900;
  color: #c87800;
  line-height: 1;
  margin-bottom: 6px;
}
.injury-count-label {
  font-size: 1.35em;
  color: #966009;
  font-weight: 700;
  letter-spacing: 0.05em;
  margin-top: 7px;
  text-transform: uppercase;
}
.injury-spark-boxes {
  display: flex;
  gap: 36px;
}
.injury-spark {
  background: #fff;
  border-radius: 17px;
  box-shadow: 0 2px 17px #a3f1a130;
  min-width: 150px;
  min-height: 100px;
  text-align: center;
  padding: 19px 18px 11px 18px;
  display: flex; flex-direction: column; justify-content: center;
  border-left-width: 7px;
  border-left-style: solid;
}
.spark-active { border-left-color: #ec760f;}
.spark-recovered { border-left-color: #077f32;}
.spark-label {
  font-size: 1.08em;
  color: #656671;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .04em;
  margin-bottom: 9px;
}
.spark-value {
  font-size: 2.45em;
  font-weight: 900;
  color: #ec760f;
  line-height: 1;
}
.spark-recovered .spark-value { color: #077f32; }

.injury-banner-right {
  flex: 1 1 350px;
  margin-left: 30px;
  min-width: 340px;
  display: flex; flex-direction: column; justify-content: center;
}
.injury-banner-title {
  font-size: 2.8em;
  font-weight: 900;
  color: #c24400;
  margin-bottom: 12px;
  letter-spacing: .01em;
}
.injury-banner-desc {
  font-size: 1.45em;
  color: #7b7472;
  font-weight: 500;
  max-width: 540px;
}
@media (max-width:1100px) {
  .injury-dashboard-banner { flex-direction:column; align-items: flex-start; gap:22px; padding: 24px 5vw 18px 6vw;}
  .injury-banner-title {font-size:2em;}
  .injury-count-card{min-width:120px;}
  .injury-spark{min-width:80px;}
}
@media (max-width:700px) {
  .injury-dashboard-banner {padding: 7px 2vw 8px 3vw;}
  .injury-banner-title {font-size:1.1em;}
  .injury-count-card, .injury-spark{padding:8px;}
}
.player-table-card {
  margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 24px 0 #0001;
  padding: 36px 26px 30px 26px; max-width: 98vw;
}
.injury-table { min-width: 1200px; border-collapse: collapse; }
.injury-table thead th {
  font-weight: bold; color: #eb5700; background: #fff4ea; border-bottom: 2.5px solid #ffecd1;
}
.injury-table td, .injury-table th {
  vertical-align: middle;
}
.table-responsive { overflow-x: auto; width: 100%; }
.table-striped tbody tr:nth-of-type(odd) {
  background: #fff9f3;
}
.filter-dropdown-btn {
  margin-right: 16px;
}
.filter-popover {
  display: none;
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  z-index: 1050;
  background: #fafafd;
  border-radius: 11px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  min-width: 320px;
  padding: 22px 18px 14px 18px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
}
.show-filters {
  display: block !important;
}
.table-actions a {
  margin-right: 7px; font-size: 1.12em; color: #ec760f;
}
.table-actions a:hover {
  color: #ef3942;
}
.filter-active-badge {
  background:#ffe7cc; color:#be6600; border-radius:14px; font-size:0.97em;
  padding:2px 13px; margin-right:4px;
}
.filter-remove-x {
  color:#c13a3a; margin-left:7px; cursor:pointer;
}
.daterange-container input {
 width: 130px; margin-right: 5px; 
}
.modal-backdrop-blue {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,255,0.15);
  z-index: 1040;
  display: none;
}
.modal-backdrop-blue.show { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="injury-dashboard-banner">
  <div class="injury-banner-left">
    <div class="injury-count-card">
      <div class="injury-count">{{ injury_total }}</div>
      <div class="injury-count-label">Total Injuries</div>
    </div>
    <div class="injury-spark-boxes">
      <div class="injury-spark spark-active"><span class="spark-label">Active Injuries</span><span class="spark-value">{{ injury_open }}</span></div>
      <div class="injury-spark spark-recovered"><span class="spark-label">Recovered</span><span class="spark-value">{{ injury_closed }}</span></div>
    </div>
  </div>
<div class="injury-spark-boxes" style="gap: 20px; margin-top: 15px;">
  <div class="injury-spark" style="border-left-color: #238823;">
    <span class="spark-label">Full Participation</span>
    <span class="spark-value" style="color: #238823;">0</span>
  </div>
  <div class="injury-spark" style="border-left-color: #ff8c00;">
    <span class="spark-label">Limited Participation</span>
    <span class="spark-value" style="color: #ff8c00;">0</span>
  </div>
  <div class="injury-spark" style="border-left-color: #d43030;">
    <span class="spark-label">No Participation</span>
    <span class="spark-value" style="color: #d43030;">0</span>
  </div>
</div>

</div>

<div id="modalBackdrop" class="modal-backdrop-blue"></div>

<div class="player-table-card position-relative">
  <h3 class="mb-3 text-center" style="color:#cf2e04; font-weight:600;">Injury List</h3>

  <div class="d-flex align-items-center flex-wrap mb-2 justify-content-between">

    <input id="playerSearch" type="text" placeholder="Search player name..." class="form-control form-control-sm" style="min-width:250px;" value="{{ active_filters.name }}">

    <div class="d-flex align-items-center gap-3 flex-wrap">

      <select id="dateFilterSelect" class="form-control form-control-sm" style="width: 180px;">
        <option value="">Select Date Filter</option>
        <option value="current_month" {% if not filter_range and not filter_month and not filter_season and not start_date %}selected{% endif %}>Current Month</option>
        <option value="last3" {% if filter_range == "last3" %}selected{% endif %}>Last 3 Months</option>
        <option value="last6" {% if filter_range == "last6" %}selected{% endif %}>Last 6 Months</option>
        <option value="season" {% if filter_season %}selected{% endif %}>Season Wise</option>
        <option value="daterange" {% if start_date and end_date %}selected{% endif %}>Start - End Dates</option>
        <option value="monthyear" {% if filter_month and filter_year %}selected{% endif %}>Month & Year</option>
      </select>

      <select id="seasonSelect" class="form-control form-control-sm" style="width: 150px; display:none;">
        <option value="">-- Select Season --</option>
        {% for s in season_choices %}
          <option value="{{ s }}" {% if filter_season == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>

      <div class="daterange-container" style="display:none;">
        <input type="date" id="startDate" class="form-control form-control-sm" placeholder="Start Date" value="{{ start_date|default:'' }}">
        <input type="date" id="endDate" class="form-control form-control-sm" placeholder="End Date" value="{{ end_date|default:'' }}">
      </div>

      <div id="monthYearInputs" style="display:none;">
        <select id="monthSelect" class="form-control form-control-sm" style="width: 120px;">
          <option value="">-- Month --</option>
          {% for num, name in MONTH_CHOICES %}
            <option value="{{ num }}" {% if filter_month|stringformat:"i" == num|stringformat:"i" %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
        <input type="number" id="yearInput" class="form-control form-control-sm" style="width: 90px;" min="2020" max="2100" value="{{ filter_year|default:today.year }}">
      </div>

      <button id="applyDateFilterBtn" class="btn btn-primary btn-sm">Apply</button>
      <button id="clearDateFilterBtn" class="btn btn-light btn-sm">Clear</button>

      <button type="button" class="btn btn-primary btn-sm filter-dropdown-btn" id="filterBtn">
        <i class="fa fa-filter"></i> Filters
        {% if filters_count %}<span class="badge badge-warning ml-1">{{ filters_count }}</span>{% endif %}
      </button>

      <button type="button" class="btn btn-success btn-sm" id="downloadExcelBtn" style="margin-left:8px;">
        <i class="fa fa-file-excel"></i> Export
      </button>

      {% if filters_count %}
        <a class="btn btn-light btn-sm ml-2" href="{% url 'organization_injury_list' %}">Clear All</a>
      {% endif %}
    </div>
  </div>

  {% if filters_count %}
  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <strong>Active Filters:</strong>
    {% if active_filters.name %}
      <span class="filter-active-badge">
        Search Player: {{ active_filters.name }}
        <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}{% if k != 'name' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}{% endfor %}" class="filter-remove-x" title="Remove search filter">&#10005;</a>
      </span>
    {% endif %}
    {% if active_filters.range %}
      <span class="filter-active-badge">
        Quick Range:
        {% if active_filters.range == 'last3' %}Last 3 Months{% elif active_filters.range == 'last6' %}Last 6 Months{% endif %}
        <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}{% if k != 'range' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}{% endfor %}" class="filter-remove-x" title="Remove range filter">&#10005;</a>
      </span>
    {% endif %}
    {% if active_filters.season %}
      <span class="filter-active-badge">
        Season: {{ active_filters.season }}
        <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}{% if k != 'season' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}{% endfor %}" class="filter-remove-x" title="Remove season filter">&#10005;</a>
      </span>
    {% endif %}
    {% if active_filters.start_date or active_filters.end_date %}
      <span class="filter-active-badge">
        Date Range: {{ active_filters.start_date|default:"Any" }} - {{ active_filters.end_date|default:"Any" }}
        <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}{% if k != 'start_date' and k != 'end_date' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}{% endfor %}" class="filter-remove-x" title="Remove date range filter">&#10005;</a>
      </span>
    {% endif %}
    {% if active_filters.month and active_filters.year %}
      <span class="filter-active-badge">
        Month-Year:
        {% for num, name in MONTH_CHOICES %}
          {% if num|stringformat:"i" == active_filters.month|stringformat:"i" %}{{ name }}{% endif %}
        {% endfor %} - {{ active_filters.year }}
        <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}{% if k != 'month' and k != 'year' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}{% endfor %}" class="filter-remove-x" title="Remove month/year filter">&#10005;</a>
      </span>
    {% endif %}
  </div>
  {% endif %}

  <div class="filter-popover" id="filterPopover">
    <form method="get" class="w-100" id="filterFormPopover" autocomplete="off">
      <button class="btn-close-filter" type="button" id="closeFilterBtn" style="font-size: 30px;">&times;</button>

      {% comment %} <div class="form-group">
        <label><b>Severity</b></label>
        <select multiple name="severity" class="form-control form-control-sm">
          {% for val, label in SEVERITY_CHOICES %}
            <option value="{{ val }}" {% if val in active_filters.severity %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div> {% endcomment %}
      <div class="form-group">
        <label><b>Status</b></label>
        <select multiple name="status" class="form-control form-control-sm">
          {% for val, label in STATUS_CHOICES %}
            <option value="{{ val }}" {% if val in active_filters.status %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label><b>Categories</b></label>
        <select multiple name="category" class="form-control form-control-sm">
          {% for cat in CATEGORY_CHOICES %}
            <option value="{{ cat }}" {% if cat in filter_categories %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="text-right mt-3"><button class="btn btn-primary btn-sm" type="submit">Apply</button></div>
    </form>
  </div>

  <div class="table-responsive">
  <table class="table table-striped injury-table align-middle">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Player</th>
        <th>Title</th>
        <th>Nature Type</th>
        <th>Severity Rating</th>
        <th>Date</th>
        <th>Expected Return</th>
        <th>Injury Status</th>
        <th>Reported By</th>
        <th>Player Status</th>
        <th>Body Region</th>
        <th>Venue</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for injury in injuries %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td style="font-weight:600; color:#cb6a01;">{{ injury.player.name }}</td>
        <td>{{ injury.name }}</td>
        <td>{{ injury.nature_of_injury }}</td>
        <td>{{ injury.severity_rating }}</td>
        <td>{% if injury.injury_date %}{{ injury.injury_date|date:"d M Y" }}{% endif %}</td>
        <td>
          {% if injury.expected_date_of_return %}
            {{ injury.expected_date_of_return|date:"d M Y" }}
          {% elif injury.unknown_injury_date %}
            Unknown
          {% else %}
            Not Available
          {% endif %}
        </td>
        <td>{{ injury.get_status_display }}</td>
        <td>{% if injury.reported_by %}{{ injury.reported_by.name }}{% endif %}</td>
        <td>{{ injury.player.player_status|title }}</td>
        <td>{{ injury.affected_body_part|title }}</td>
        
        <td>{{ injury.venue }}</td>
        <td>{% if injury.notes %}<span title="{{ injury.notes }}">{{ injury.notes|truncatechars:30 }}</span>{% endif %}</td>
        <td>
          <a href="{% url 'organization_injury_detail' injury.id %}" title="Details"><i class="fa fa-eye"></i></a>
          <a href="{% url 'organization_injury_edit' injury.id %}" title="Edit"><i class="fa fa-pen"></i></a>
          <a href="{% url 'organization_injury_delete' injury.id %}" title="Delete" onclick="return confirm('Delete injury {{ injury }}?')"><i class="fa fa-trash"></i></a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="14" class="text-center text-muted">No injuries found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

</div>


<script>
  // Filter popover toggle
  const filterBtn = document.getElementById("filterBtn");
  const filterPopover = document.getElementById("filterPopover");
  const closeFilterBtn = document.getElementById("closeFilterBtn");
  const modalBackdrop = document.getElementById("modalBackdrop");

  filterBtn.addEventListener("click", () => {
    filterPopover.style.display = "block";
    modalBackdrop.style.display = "block";
  });
  closeFilterBtn.addEventListener("click", () => {
    filterPopover.style.display = "none";
    modalBackdrop.style.display = "none";
  });
  modalBackdrop.addEventListener("click", () => {
    filterPopover.style.display = "none";
    modalBackdrop.style.display = "none";
  });

  document.addEventListener('click', function(e) {
    if (filterBtn && filterPopover) {
      if (filterBtn.contains(e.target)) {
        filterPopover.classList.toggle("show-filters");
        filterPopover.style.left = (filterBtn.offsetLeft) + "px";
        filterPopover.style.top = (filterBtn.offsetTop + filterBtn.offsetHeight + 6) + "px";
      } else if (!filterPopover.contains(e.target)) {
        filterPopover.classList.remove("show-filters");
      }
    }
  });
  if (closeFilterBtn && filterPopover) {
    closeFilterBtn.onclick = function() {
      filterPopover.classList.remove('show-filters');
    };
  }

  // Column popover toggle and logic
  const columnBtn = document.getElementById("columnSelectBtn");
  const columnPopover = document.getElementById("columnPopover");
  const closeColumnBtn = document.getElementById("closeColumnBtn");
  const colCheckboxes = document.querySelectorAll(".col-toggle");
  const applyColumnsBtn = document.getElementById("applyColumnsBtn");
  const FIXED_COLS = ["col-serial", "col-player", "col-title", "col-actions"];
  const ALL_SWAP_COLS = [
    "col-type", "col-severity", "col-date", "col-return", "col-status", "col-reported",
    "col-region", "col-segment", "col-venue", "col-notes"
  ];
  const MAX_SELECTABLE = 4;

  function getSelectedCols() {
    return Array.from(colCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
  }
  function setTableColumns(selectedCols) {
    [...FIXED_COLS, ...ALL_SWAP_COLS].forEach(col => {
      document.querySelectorAll('.' + col).forEach(cell => {
        if (FIXED_COLS.includes(col))
          cell.style.display = "";
        else
          cell.style.display = selectedCols.includes(col) ? "" : "none";
      });
    });
  }
  function saveSelectedCols(cols) {
    localStorage.setItem("injury_table_columns", JSON.stringify(cols));
  }
  function loadSelectedCols() {
    let val = localStorage.getItem("injury_table_columns");
    try {
      return val ? JSON.parse(val) : null;
    } catch {
      return null;
    }
  }
  function enforceMaxSelectable(e) {
    const checked = getSelectedCols();
    if (checked.length > MAX_SELECTABLE) {
      e.target.checked = false;
      alert("You can select only " + MAX_SELECTABLE + " additional columns.");
    }
  }
  colCheckboxes.forEach(cb => { cb.addEventListener("change", enforceMaxSelectable); });

  if (columnBtn && columnPopover) {
    columnBtn.onclick = function() {
      columnPopover.classList.toggle("show-filters");
      columnPopover.style.left = (columnBtn.offsetLeft) + "px";
      columnPopover.style.top = (columnBtn.offsetTop + columnBtn.offsetHeight + 6) + "px";
      const stored = loadSelectedCols() || ALL_SWAP_COLS.slice(0, MAX_SELECTABLE);
      colCheckboxes.forEach(cb => cb.checked = stored.includes(cb.value));
    };
  }
  if (closeColumnBtn && columnPopover) {
    closeColumnBtn.onclick = function() {
      columnPopover.classList.remove('show-filters');
    };
  }
  if (applyColumnsBtn) {
    applyColumnsBtn.onclick = function() {
      const selected = getSelectedCols();
      if (selected.length === 0) {
        alert("Select at least one additional column."); return;
      }
      setTableColumns(selected);
      saveSelectedCols(selected);
      columnPopover.classList.remove('show-filters');
    };
  }
  document.addEventListener("DOMContentLoaded", function() {
    const stored = loadSelectedCols();
    setTableColumns(stored || ALL_SWAP_COLS.slice(0, MAX_SELECTABLE));
  });

  // Export button preserving filters
  document.getElementById("downloadExcelBtn").onclick = function() {
    let url = "{% url 'organization_injury_export' %}";
    let params = new URLSearchParams(window.location.search);
    window.location.href = url + (params.toString() ? ("?" + params.toString()) : "");
  };
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dateFilterSelect = document.getElementById('dateFilterSelect');
    const seasonSelect = document.getElementById('seasonSelect');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const monthSelect = document.getElementById('monthSelect');
    const yearInput = document.getElementById('yearInput');
    const applyBtn = document.getElementById('applyDateFilterBtn');
    const clearBtn = document.getElementById('clearDateFilterBtn');
    const playerSearch = document.getElementById('playerSearch');

    const seasonInput = seasonSelect.parentElement;
    const dateRangeInputs = startDateInput.parentElement;
    const monthYearInputs = monthSelect.parentElement;

    let debounceTimeout = null;

    function hideAllDateInputs() {
      seasonInput.style.display = 'none';
      dateRangeInputs.style.display = 'none';
      monthYearInputs.style.display = 'none';
    }

    function showInputByType(type) {
      hideAllDateInputs();
      switch (type) {
        case 'season':
          seasonInput.style.display = 'inline-block';
          break;
        case 'daterange':
          dateRangeInputs.style.display = 'inline-flex';
          break;
        case 'monthyear':
          monthYearInputs.style.display = 'inline-flex';
          break;
      }
    }

    // On dropdown change
    dateFilterSelect.addEventListener('change', () => {
      showInputByType(dateFilterSelect.value);
    });

    // Initialize visibility on page load
    showInputByType(dateFilterSelect.value);

    function updateUrl(params) {
      let url = new URL(window.location.href);
      url.search = params.toString();
      window.location.href = url.toString();
    }

    applyBtn.addEventListener('click', () => {
      let params = new URLSearchParams(window.location.search);

      // Clear filters except search
      ['range', 'season', 'start_date', 'end_date', 'month', 'year', 'name'].forEach(k => params.delete(k));

      // If player search is non-empty, only search by player name
      if (playerSearch.value.trim() !== '') {
        params.set('name', playerSearch.value.trim());
      } else {
        // Apply selected date filter
        switch (dateFilterSelect.value) {
          case 'current_month': {
            const now = new Date();
            params.set('month', now.getMonth() + 1); // JS month 0-based
            params.set('year', now.getFullYear());
            break;
          }
          case 'last3':
          case 'last6':
            params.set('range', dateFilterSelect.value);
            break;
          case 'season':
            if (seasonSelect.value) params.set('season', seasonSelect.value);
            break;
          case 'daterange':
            if (startDateInput.value) params.set('start_date', startDateInput.value);
            if (endDateInput.value) params.set('end_date', endDateInput.value);
            break;
          case 'monthyear':
            if (monthSelect.value) params.set('month', monthSelect.value);
            if (yearInput.value) params.set('year', yearInput.value);
            break;
        }
      }
      updateUrl(params);
    });

    clearBtn.addEventListener('click', () => {
      playerSearch.value = '';
      dateFilterSelect.value = '';
      hideAllDateInputs();

      let params = new URLSearchParams(window.location.search);
      ['range', 'season', 'start_date', 'end_date', 'month', 'year', 'name'].forEach(k => params.delete(k));
      updateUrl(params);
    });

    playerSearch.addEventListener('input', () => {
      if (debounceTimeout) clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        let params = new URLSearchParams(window.location.search);
        if (playerSearch.value.trim().length > 0) {
          // Clear all filters except search
          ['range', 'season', 'start_date', 'end_date', 'month', 'year'].forEach(k => params.delete(k));
          params.set('name', playerSearch.value.trim());
        } else {
          params.delete('name');
        }
        window.location.search = params.toString();
      }, 500);
    });

    // Modal center and blue overlay logic for filter modal
    const filterBtn = document.getElementById("filterBtn");
    const filterPopover = document.getElementById("filterPopover");
    const closeFilterBtn = document.getElementById("closeFilterBtn");

    // Create blue overlay div dynamically if not present
    let modalBackdrop = document.getElementById("modalBackdrop");
    if (!modalBackdrop) {
      modalBackdrop = document.createElement("div");
      modalBackdrop.id = "modalBackdrop";
      modalBackdrop.style.position = "fixed";
      modalBackdrop.style.top = 0;
      modalBackdrop.style.left = 0;
      modalBackdrop.style.right = 0;
      modalBackdrop.style.bottom = 0;
      modalBackdrop.style.backgroundColor = "rgba(0,0,255,0.2)";
      modalBackdrop.style.zIndex = 1040;
      modalBackdrop.style.display = "none";
      document.body.appendChild(modalBackdrop);
    }

    // Styles for modal centering defined via JS to avoid CSS conflicts
    filterPopover.style.position = "fixed";
    filterPopover.style.top = "50%";
    filterPopover.style.left = "50%";
    filterPopover.style.transform = "translate(-50%, -50%)";
    filterPopover.style.zIndex = 1050;
    filterPopover.style.backgroundColor = "white";
    filterPopover.style.borderRadius = "10px";
    filterPopover.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
    filterPopover.style.padding = "20px";
    filterPopover.style.minWidth = "400px";
    filterPopover.style.maxWidth = "90vw";
    filterPopover.style.maxHeight = "80vh";
    filterPopover.style.overflowY = "auto";
    filterPopover.style.display = "none";

    filterBtn.addEventListener("click", () => {
      const isShown = filterPopover.style.display === "block";
      if (isShown) {
        filterPopover.style.display = "none";
        modalBackdrop.style.display = "none";
      } else {
        filterPopover.style.display = "block";
        modalBackdrop.style.display = "block";
      }
    });

    closeFilterBtn.addEventListener("click", () => {
      filterPopover.style.display = "none";
      modalBackdrop.style.display = "none";
    });

    modalBackdrop.addEventListener("click", () => {
      filterPopover.style.display = "none";
      modalBackdrop.style.display = "none";
    });
  });
</script>

{% comment %} Player status {% endcomment %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
  // Select the participation count display spans by border-left color style attribute
  const fullParticipationCard = document.querySelector('.injury-spark[style*="#238823"] .spark-value');
  const limitedParticipationCard = document.querySelector('.injury-spark[style*="#ff8c00"] .spark-value');
  const noParticipationCard = document.querySelector('.injury-spark[style*="#d43030"] .spark-value');

  const fullSet = new Set();
  const limitedSet = new Set();
  const noSet = new Set();

  // Select all table rows in the injury list table body
  const rows = document.querySelectorAll('table.injury-table tbody tr');

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    // Make sure this is not an empty/no data row by checking cells count
    if (cells.length === 14) {
      const playerName = cells[1].textContent.trim();
      const playerStatus = cells[9].textContent.trim().toLowerCase();

      if (playerStatus === "full participation") {
        fullSet.add(playerName);
      } else if (playerStatus === "limited participation") {
        limitedSet.add(playerName);
      } else if (playerStatus === "no participation") {
        noSet.add(playerName);
      }
    }
  });

  // Set the count text
  if (fullParticipationCard) fullParticipationCard.textContent = fullSet.size;
  if (limitedParticipationCard) limitedParticipationCard.textContent = limitedSet.size;
  if (noParticipationCard) noParticipationCard.textContent = noSet.size;
});
</script>


{% comment %} Injuries card code {% endcomment %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Injury status column is the 8th cell (index 7) in each row
    const statusColIndex = 7;
    let totalInjuries = 0;
    let activeInjuries = 0;
    let recoveredInjuries = 0;

    document.querySelectorAll('table.injury-table tbody tr').forEach(row => {
      const cells = row.querySelectorAll('td');
      // skip rows that are empty messages (no injuries found)
      if (cells.length > statusColIndex) {
        totalInjuries++;
        const status = cells[statusColIndex].textContent.trim().toLowerCase();
        if (status === "open") {
          activeInjuries++;
        } else if (status === "close") {
          recoveredInjuries++;
        }
      }
    });

    // Update the cards
    const totalCard = document.querySelector('.injury-count');
    const activeCard = document.querySelector('.spark-active .spark-value');
    const recoveredCard = document.querySelector('.spark-recovered .spark-value');

    if (totalCard) totalCard.textContent = totalInjuries;
    if (activeCard) activeCard.textContent = activeInjuries;
    if (recoveredCard) recoveredCard.textContent = recoveredInjuries;
  });
</script>
{% endblock %}
