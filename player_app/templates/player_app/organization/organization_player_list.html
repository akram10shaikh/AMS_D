{% extends "player_app/organization/base.html" %}
{% load static %}
{% load player_extras %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
.player-table-card {
    margin: 40px auto;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 24px 0 #0001;
    padding: 36px 26px 30px 26px;
    max-width: 98vw;
}
.player-table thead th {
    font-weight: bold;
    color: #6200ee;
    background: #f1f0fe;
    border-bottom: 2.5px solid #e9e7fd;
}
.player-table td, .player-table th { vertical-align: middle; }
.table-responsive { overflow-x: auto;}
.table-striped tbody tr:nth-of-type(odd) { background: #fcfbfe;}
.filter-dropdown-btn {margin-right:16px;}
.filter-popover {
    display: none;
    position: absolute; z-index: 99;
    min-width: 320px;
    padding: 22px 18px 14px 18px;
    background: #fafafd; border-radius: 11px; box-shadow: 0 2px 22px #0002;
    top: 50px; left: 0; right: auto;
    max-width:95vw;
}
.show-filters { display: block !important; }
@media(max-width:700px){ .filter-popover{min-width: 90vw; left:10px;} }
.btn-close-filter { float:right; color:#a22; background:none; border:none; }
.table-actions a { margin-right: 7px; font-size:1.12em; color: #4547b7;}
.table-actions a:hover { color: #ef3942; }
.filter-active-badge { background:#e4eaff; color:#4b4d6c; border-radius:14px; font-size:0.97em; padding:2px 13px; margin-right:4px;}
.filter-remove-x { color:#c13a3a; margin-left:7px; cursor:pointer; }
</style>
{% endblock %}

{% block content %}
<div class="player-table-card position-relative">
    <div style="display:flex; justify-content: space-around; margin-bottom:20px;">
    <div id="fullParticipationCard" style="background:#d4edda; color:#155724; padding:15px; border-radius:8px; width:30%; text-align:center;">
        <h4>Full Participation</h4>
        <p id="fullParticipationCount">0</p>
    </div>
    <div id="limitedParticipationCard" style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; width:30%; text-align:center;">
        <h4>Limited Participation</h4>
        <p id="limitedParticipationCount">0</p>
    </div>
    <div id="noParticipationCard" style="background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; width:30%; text-align:center;">
        <h4>No Participation</h4>
        <p id="noParticipationCount">0</p>
    </div>
</div>
    <h3 class="mb-3 text-center" style="color:#6200ee; font-weight:600;">Player List</h3>

<div class="d-flex align-items-center flex-wrap mb-2" style="position:relative;">
    <button type="button" class="btn btn-primary btn-sm filter-dropdown-btn" id="filterBtn">
        <i class="fa fa-filter"></i> Filter
        {% if filters_count %}<span class="badge badge-warning ml-1">{{ filters_count }}</span>{% endif %}
    </button>
    <button type="button" class="btn btn-success btn-sm" id="downloadExcelBtn" style="margin-left:8px;">
        <i class="fa fa-file-excel"></i> Export
    </button>
    <input type="text" id="playerSearchInput" class="form-control form-control-sm"
    style="width:220px; display:inline-block; margin-left:8px;" placeholder="Search by name ..." autocomplete="off">

    {% comment %} <button type="button" class="btn btn-secondary btn-sm" id="columnSelectBtn" style="margin-left:8px;">
        <i class="fa fa-columns"></i> Columns
    </button> {% endcomment %}
    {% if filters_count %}
        <a class="btn btn-light btn-sm ml-2" href="{% url 'organization_player_list' %}">Clear All</a>
    {% endif %}
</div>

<!-- Filter Popover Menu -->
<div class="filter-popover" id="filterPopover">
    <form method="get" class="w-100" id="filterFormPopover" autocomplete="off">
        <button class="btn-close-filter" type="button" id="closeFilterBtn">&times;</button>
        <div class="form-group">
            <label for="id_age_category"><b>Age Category</b></label>
            <select multiple name="age_category" class="form-control form-control-sm" id="id_age_category">
                {% for val, label in AGE_CHOICES %}
                    <option value="{{ val }}" {% if val in active_filters.age_category %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_handedness"><b>Handedness</b></label>
            <select multiple name="handedness" class="form-control form-control-sm" id="id_handedness">
                {% for val, label in HAND_CHOICES %}
                    <option value="{{ val }}" {% if val in active_filters.handedness %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_role"><b>Role</b></label>
            <select multiple name="role" class="form-control form-control-sm" id="id_role">
                {% for val in ROLE_CHOICES %}
                    {% if val %}
                        <option value="{{ val }}" {% if val in active_filters.role %}selected{% endif %}>{{ val }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_player_status"><b>Player Status</b></label>
            <select multiple name="player_status" class="form-control form-control-sm" id="id_player_status">
                <option value="full participation" {% if "Full Participation" in active_filters.player_status %}selected{% endif %}>Full Participation</option>
                <option value="limited participation" {% if "Limited Participation" in active_filters.player_status %}selected{% endif %}>Limited Participation</option>
                <option value="no participation" {% if "No Participation" in active_filters.player_status %}selected{% endif %}>No Participation</option>
            </select>
        </div>
        <div class="text-right mt-3">
            <button class="btn btn-primary btn-sm" type="submit">Apply</button>
        </div>
    </form>
</div>

<!-- Column Selection Popover -->
<div class="filter-popover" style="min-width:240px;" id="columnPopover">
    <button class="btn-close-filter" type="button" id="closeColumnBtn">&times;</button>
    <form id="columnFormPopover" class="w-100 px-2 py-1" autocomplete="off">
        <label class="mb-2"><b>Select additional columns (choose up to 4)</b></label>
        <div style="max-height:350px;overflow:auto;">
            <label><input type="checkbox" checked disabled> S.No (fixed)</label><br>
            <label><input type="checkbox" checked disabled> Player ID (fixed)</label><br>
            <label><input type="checkbox" checked disabled> Name (fixed)</label><br>
            <!-- All optional columns checked by default -->
            <label><input type="checkbox" class="col-toggle" value="col-email" checked> Email</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-dob" checked> D.O.B </label><br>
            <label><input type="checkbox" class="col-toggle" value="col-age-current" checked> Age </label><br>
            <label><input type="checkbox" class="col-toggle" value="col-contact" checked> Primary Contact</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-contact2" checked> Secondary Contact</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-gender" checked> Gender</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-state" checked> State</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-role" checked> Role</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-player-status" checked> Player Status</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-batting" checked> Batting Style</label><br>
            
            <label><input type="checkbox" class="col-toggle" value="col-bowling" checked> Bowling Style</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-handedness" checked> Handedness</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-age" checked> Age Category</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-guardian" checked> Guardian Name</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-relation" checked> Relation</label><br>
            <label><input type="checkbox" class="col-toggle" value="col-guardian-mob" checked> Guardian Mobile</label>
        </div>
        <div class="text-right mt-2">
            <button type="button" class="btn btn-primary btn-sm" id="applyColumnsBtn">Apply</button>
        </div>
    </form>
</div>

{% if filters_count %}
<div class="mb-2 d-flex align-items-center flex-wrap">
    {% for val in active_filters.age_category %}
        <span class="filter-active-badge">
            Age: {{ AGE_CHOICES|get_label_from_choice:val }}
            <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}
                {% if k != 'age_category' or v != val %}
                    {{ k }}={{ v|urlencode }}&
                {% endif %}
            {% endfor %}{% endfor %}" class="filter-remove-x" title="Remove">&#10005;</a>
        </span>
    {% endfor %}
    {% for val in active_filters.handedness %}
        <span class="filter-active-badge">
            Handedness: {{ HAND_CHOICES|get_label_from_choice:val }}
            <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}
                {% if k != 'handedness' or v != val %}
                    {{ k }}={{ v|urlencode }}&
                {% endif %}
            {% endfor %}{% endfor %}" class="filter-remove-x" title="Remove">&#10005;</a>
        </span>
    {% endfor %}
    {% for val in active_filters.role %}
        <span class="filter-active-badge">
            Role: {{ val }}
            <a href="?{% for k, v_list in request_getlist.items %}{% for v in v_list %}
                {% if k != 'role' or v != val %}{{ k }}={{ v|urlencode }}&{% endif %}
            {% endfor %}{% endfor %}" class="filter-remove-x" title="Remove">&#10005;</a>
        </span>
    {% endfor %}
    <span class="text-info ml-2">Filters applied: {{ filters_count }}</span>
</div>
{% endif %}

<div class="table-responsive">
    <table class="table table-striped player-table align-middle">
        <thead>
            <tr>
                <th class="col-serial">S.No</th>
                <th class="col-id">Player ID</th>
                <th class="col-name">Name</th>
                <th class="col-role">Role</th>
                <th class="col-player-status">Player Status</th>
                <th class="col-batting">Batting Style</th>
                <th class="col-bowling">Bowling Style</th>
                <th class="col-handedness">Handedness</th>
                <th class="col-skill">Skill Status</th>
                <th class="col-traning">Training Status</th>
                <th class="col-age">Age Category</th>
                <th class="col-email">Email</th>
                <th class="col-dob">D.O.B</th>
                <th class="col-age-current">Age</th>
                
                <th class="col-gender">Gender</th>
                <th class="col-state">State</th>
                <th class="col-role">District</th>

                <th class="col-contact">Primary Contact</th>
                <th class="col-contact2">Secondary Contact</th>
                {% comment %} <th class="col-guardian">Guardian Name</th>
                <th class="col-relation">Relation</th>
                <th class="col-guardian-mob">Guardian Mobile</th> {% endcomment %}
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td class="col-serial">{{ forloop.counter }}</td>
                <td class="col-id">{{ player.id }}</td>
                <td class="col-name" style="font-weight:600; color:#222f5a;">{{ player.name }}</td>
                 <td class="col-role">{{ player.role }}</td>
                <td class="col-player-status">{{ player.player_status }}</td>
                <td class="col-batting">{{ player.batting_style }}</td>
                <td class="col-bowling">{{ player.bowling_style }}</td>
                <td class="col-handedness">{{ player.get_handedness_display }}</td>
                <td class="col-skill">{{ player.skill_status }}</td>
                <td class="col-traning">{{ player.traning_status }}</td>
                <td class="col-age">{% if player.age_category %}{{ player.get_age_category_display }}{% endif %}</td>
                <td class="col-email">{{ player.email }}</td>
                <td class="col-dob">{% if player.date_of_birth %}{{ player.date_of_birth|date:"d M Y" }}{% endif %}</td>
                <td class="col-age-current">{{ player.current_age }}</td>
                <td class="col-gender">{{ player.get_gender_display }}</td>
                <td class="col-state">{{ player.state }}</td>
                <td class="col-role">{{ player.district }}</td>
               
                <td class="col-contact">{{ player.primary_contact_number }}</td>
                <td class="col-contact2">{{ player.secondary_contact_number }}</td>
                {% comment %} <td class="col-guardian">{{ player.guardian_name }}</td>
                <td class="col-relation">{{ player.relation }}</td>
                <td class="col-guardian-mob">{{ player.guardian_mobile_number }}</td> {% endcomment %}
                <td class="col-actions table-actions">
                    <a href="{% url 'organization_player_detail' player.id %}" title="Details"><i class="fa fa-eye"></i></a>
                    <a href="{% url 'organization_player_edit' player.id %}" title="Edit"><i class="fa fa-pen"></i></a>
                    <a href="{% url 'organization_player_delete' player.id %}" title="Delete" onclick="return confirm('Delete player {{ player.name }}?')"><i class="fa fa-trash"></i></a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="18" class="text-center text-muted">No players found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<script>
// Filter popover logic
const filterBtn = document.getElementById("filterBtn");
const filterPopover = document.getElementById("filterPopover");
const closeFilterBtn = document.getElementById("closeFilterBtn");

document.addEventListener('click', function(e) {
    if (filterBtn && filterPopover) {
        if (filterBtn.contains(e.target)) {
            filterPopover.classList.toggle("show-filters");
            filterPopover.style.left = (filterBtn.offsetLeft) + "px";
            filterPopover.style.top = (filterBtn.offsetTop + filterBtn.offsetHeight + 6) + "px";
        } else if (!filterPopover.contains(e.target)) {
            filterPopover.classList.remove("show-filters");
        }
    }
});
if (closeFilterBtn && filterPopover) {
    closeFilterBtn.onclick = function() {
        filterPopover.classList.remove('show-filters');
    };
}

// Column selection popover logic
const columnBtn = document.getElementById("columnSelectBtn");
const columnPopover = document.getElementById("columnPopover");
const closeColumnBtn = document.getElementById("closeColumnBtn");
const colCheckboxes = document.querySelectorAll(".col-toggle");
const applyColumnsBtn = document.getElementById("applyColumnsBtn");

const FIXED_COLS = ["col-serial", "col-id", "col-name", "col-actions"];
const ALL_SWAP_COLS = [
    "col-email", "col-dob", "col-contact", "col-contact2", "col-gender", "col-state", "col-role",
    "col-batting", "col-bowling", "col-handedness", "col-age",
    "col-guardian", "col-relation", "col-guardian-mob"
];
const MAX_SELECTABLE = 4;

function getSelectedCols() {
    return Array.from(colCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
}
function setTableColumns(selectedCols) {
    [...FIXED_COLS, ...ALL_SWAP_COLS].forEach(col => {
        document.querySelectorAll('.' + col).forEach(cell => {
            if (FIXED_COLS.includes(col)) {
                cell.style.display = "";
            } else {
                cell.style.display = selectedCols.includes(col) ? "" : "none";
            }
        });
    });
}
function saveSelectedCols(cols) {
    localStorage.setItem("player_table_columns", JSON.stringify(cols));
}
function loadSelectedCols() {
    let val = localStorage.getItem("player_table_columns");
    try {
        return val ? JSON.parse(val) : null;
    } catch {
        return null;
    }
}
function enforceMaxSelectable(e) {
    const checked = getSelectedCols();
    if (checked.length > MAX_SELECTABLE) {
        e.target.checked = false;
        alert("You can select only " + MAX_SELECTABLE + " additional columns.");
    }
}
colCheckboxes.forEach(cb => {
    cb.addEventListener("change", enforceMaxSelectable);
});

if (columnBtn && columnPopover) {
    columnBtn.onclick = function() {
        columnPopover.classList.toggle("show-filters");
        columnPopover.style.left = (columnBtn.offsetLeft) + "px";
        columnPopover.style.top = (columnBtn.offsetTop + columnBtn.offsetHeight + 6) + "px";
        colCheckboxes.forEach(cb => cb.checked = true);
    };
}
if (closeColumnBtn && columnPopover) {
    closeColumnBtn.onclick = function() {
        columnPopover.classList.remove('show-filters');
    };
}
if (applyColumnsBtn) {
    applyColumnsBtn.onclick = function() {
        const selected = getSelectedCols();
        if (selected.length === 0) {
            alert("Select at least one additional column.");
            return;
        }
        setTableColumns(selected);
        saveSelectedCols(selected);
        columnPopover.classList.remove('show-filters');
    };
}

// UPDATED: Dynamic search with S.No renumbering
const searchInput = document.getElementById("playerSearchInput");
const playerTable = document.querySelector(".player-table tbody");

function updateSearchAndSerialNumbers() {
    const filter = searchInput.value.trim().toLowerCase();
    const allRows = [...playerTable.rows];
    let visibleRows = [];

    if (!filter) {
        // Show all rows
        allRows.forEach(row => {
            row.style.display = "";
        });
        visibleRows = allRows;
    } else {
        // Filter rows based on name or role
        allRows.forEach(row => {
            const nameCell = row.querySelector(".col-name");
            const roleCell = row.querySelector(".col-role");

            const nameText = nameCell ? nameCell.textContent.toLowerCase() : "";
            const roleText = roleCell ? roleCell.textContent.toLowerCase() : "";

            if (nameText.includes(filter) || roleText.includes(filter)) {
                row.style.display = "";
                visibleRows.push(row);
            } else {
                row.style.display = "none";
            }
        });
    }

    // UPDATE S.No for visible rows only
    visibleRows.forEach((row, index) => {
        const serialCell = row.querySelector(".col-serial");
        if (serialCell) {
            serialCell.textContent = (index + 1);
        }
    });

    // Update participation cards
    updateParticipationCards();
}

searchInput.addEventListener("input", updateSearchAndSerialNumbers);

// UPDATED: Participation cards count only VISIBLE rows
function updateParticipationCards() {
    let fullCount = 0;
    let limitedCount = 0;
    let noCount = 0;

    // Only count VISIBLE rows
    document.querySelectorAll(".player-table tbody tr").forEach(row => {
        if (row.style.display !== "none") {  // Only visible rows
            const statusCell = row.querySelector(".col-player-status");
            if (statusCell) {
                const statusText = statusCell.textContent.trim().toLowerCase();
                if (statusText === "full participation") {
                    fullCount++;
                } else if (statusText === "limited participation") {
                    limitedCount++;
                } else if (statusText === "no participation") {
                    noCount++;
                }
            }
        }
    });

    document.getElementById("fullParticipationCount").textContent = fullCount;
    document.getElementById("limitedParticipationCount").textContent = limitedCount;
    document.getElementById("noParticipationCount").textContent = noCount;
}

// Export button logic
document.getElementById("downloadExcelBtn").onclick = function() {
    let url = "{% url 'organization_player_export' %}";
    let params = new URLSearchParams(window.location.search);
    window.location.href = url + (params.toString() ? ("?" + params.toString()) : "");
};

// Initialize everything on page load
document.addEventListener("DOMContentLoaded", function() {
    setTableColumns(ALL_SWAP_COLS);
    updateSearchAndSerialNumbers();  // Initial setup
    updateParticipationCards();
});

</script>
{% endblock %}
