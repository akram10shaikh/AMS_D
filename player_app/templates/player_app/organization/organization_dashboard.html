{% extends "player_app/organization/base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
 

  h1 {
    margin-bottom: 0.5em;
    font-weight: 700;
    color: #222;
    font-size: 2.5rem;
    text-align: center;
  }
  h3 {
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.3em;
    margin-bottom: 1rem;
    color: #007bff;
  }

  /* --- Filter Form Styles --- */
  .filter-form {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px 25px;
    margin-bottom: 30px;
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  .filter-form label {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #444;
    white-space: nowrap;
  }
  .filter-form select,
  .filter-form input[type=search] {
    min-width: 170px;
    padding: 9px 12px;
    font-size: 1rem;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.25s ease, box-shadow 0.25s ease;
  }
  .filter-form select:focus,
  .filter-form input[type=search]:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 6px rgba(0,123,255,0.5);
  }
  .filter-form button {
    background-color: #007bff;
    border: none;
    padding: 10px 28px;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 7px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,123,255,0.4);
    transition: background-color 0.3s ease;
  }
  .filter-form button:hover,
  .filter-form button:focus {
    background-color: #0056b3;
  }

  /* --- Cards Container --- */
  .cards {
    display: flex;
    gap: 25px;
    justify-content: center;
    margin-bottom: 40px;
    flex-wrap: wrap;
  }
  .card {
    background: white;
    padding: 30px 20px;
    width: 240px;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    text-align: center;
    color: #007bff;
    font-weight: 700;
    font-size: 1.9rem;
    user-select: none;
    transition: box-shadow 0.3s ease;
  }
  .card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.14);
  }
  .card h3 {
    font-weight: 600;
    font-size: 1.4rem;
    margin-bottom: 0.6em;
    color: #0056b3;
  }
  .card p {
    margin: 0;
    font-size: 2.8rem;
  }

  /* --- Participation Type List --- */
  .participation-list {
    list-style: none;
    padding: 0;
    max-width: 350px;
    margin: 0 auto 45px auto;
  }
  .participation-list li {
    background: white;
    padding: 14px 18px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #045cb5;
  }
  .participation-list li .count {
    font-weight: 700;
    font-size: 1.2rem;
    color: #023e7d;
  }
    .year-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .year-tab {
    border: none;
    padding: 8px 18px;
    border-radius: 6px;
    background: #f1f3f7;
    color: #333;
    font-weight: 600;
    cursor: pointer;
  }
  .year-tab.active {
    background: #fff;
    border-bottom: 3px solid #28a745;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  }
  .year-panel.hidden {
    display: none;
  }
  .view-more {
    margin-left: 12px;
    text-decoration: none;
    font-weight: 600;
    color: #007bff;
    font-size: 0.95rem;
  }
  .view-more:hover,
  .view-more:focus {
    text-decoration: underline;
  }

  /* --- Tables --- */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 18px rgba(0,0,0,0.05);
    background: white;
    margin-bottom: 50px;
  }
  thead {
    background-color: #0056b3;
    color: white;
  }
  th, td {
    padding: 14px 18px;
    text-align: left;
    font-size: 1rem;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }
  tbody tr:hover {
    background-color: #f0f7ff;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  th {
    font-weight: 700;
    user-select: none;
  }
  .note {
    font-style: italic;
    color: #555;
    white-space: pre-wrap;
  }
  /* Responsive fix: compacting filter and cards on small devices */
  @media (max-width: 940px) {
    .filter-form {
      justify-content: flex-start;
    }
    .filter-form select,
    .filter-form input[type=search] {
      min-width: 140px;
    }
    .cards {
      flex-direction: column;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }
    .card {
      width: 100%;
      max-width: none;
      margin-bottom: 20px;
    }
    .participation-list {
      max-width: 100%;
    }
  }

    .custom-tooltip {  /* ‚Üê ADD THE DOT */
      position: absolute;
      background: #222;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      max-width: 260px;
      z-index: 9999;
      white-space: pre-line;
      display: none;
   }

     .tooltip-trigger {
    position: relative;
    cursor: help;
  }
  .tooltip-box {
    position: absolute;
    background: #222;
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    max-width: 260px;
    white-space: normal;
    z-index: 9999;
    display: none;
  }
  
  .camp-section {
    margin: 35px 0 45px 0;
  }

  .camp-section__title {
    font-size: 1.6rem;
    font-weight: 700;
    color: #013a63;
    margin-bottom: 18px;
  }

  /* Tabs */
  .camp-tabs {
    display: inline-flex;
    gap: 10px;
    padding: 4px;
    border-radius: 999px;
    background: #f1f3f7;
    margin-bottom: 18px;
  }

  .camp-tabs__tab {
    border: none;
    padding: 8px 20px;
    border-radius: 999px;
    background: transparent;
    color: #495057;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
  }

  .camp-tabs__tab:hover {
    background: #e5f3ff;
  }

  .camp-tabs__tab--active {
    background: #ffffff;
    color: #198754;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  /* List */
  .camp-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .camp-list--hidden {
    display: none;
  }

  .camp-list__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    background: #ffffff;
    padding: 12px 16px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    margin-bottom: 10px;
  }

  .camp-list__item:hover {
    box-shadow: 0 4px 14px rgba(15, 23, 42, 0.12);
  }

  .camp-list__info {
    display: flex;
    flex-direction: column;
  }

  .camp-list__name {
    font-weight: 600;
    color: #0f172a;
    font-size: 0.98rem;
  }

  .camp-list__meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .camp-list__badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: help;
    white-space: nowrap;
  }

  .camp-list__badge--players {
    background: #e7f5ff;
    color: #1c7ed6;
  }

  .camp-list__badge--staff {
    background: #fff3bf;
    color: #d9480f;
  }

  .camp-list__link {
    font-size: 0.85rem;
    font-weight: 600;
    color: #2563eb;
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 6px;
    background: #e0edff;
  }

  .camp-list__link:hover {
    background: #c7ddff;
  }

  /* Tooltip */
  .tooltip-box {
    position: absolute;
    background: #111827;
    color: #f9fafb;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    max-width: 260px;
    z-index: 9999;
    display: none;
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
    white-space: normal;
  }

  @media (max-width: 768px) {
    .camp-list__item {
      flex-direction: column;
      align-items: flex-start;
    }
    .camp-tabs {
      width: 100%;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
  }

    .filter-btn.active, .filter-btn-year.active {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(54, 169, 225, 0.4) !important;
      }
      .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
      }

</style>
{% endblock %}

{% block content %}

<!-- Category Summary Cards (Dashboard Top Section) -->
<div style="background:white;padding:35px 0 25px 0;">
  <div class="cards" style="gap: 18px; justify-content:center; flex-wrap:wrap;">
    {% for cat in category_cards %}
      <div class="category-card"
           data-age-category="{{ cat.age_category }}"
           style="background:#36a9e1;border-radius:7px;width:170px;display:inline-block;padding:17px 10px 9px 10px;margin:0 7px;cursor:pointer;">
        <p align="center">
          <img src="{% static 'KCA.png' %}" width="50px" height="50px" alt="AMS logo">
        </p>
        <div style="font-size:21px;color:#fff;font-weight:700;margin-bottom:7px;text-align:center;letter-spacing:1px;">
          {{ cat.label }}
        </div>
        <div style="font-size:40px;color:#fff;font-weight:900;margin-bottom:10px;text-align:center;">
          {{ cat.total }}
        </div>
        <div style="display:flex;justify-content:center;gap:7px;margin-bottom:8px;">
          <div class="status-pill"
               data-status="full"
               style="background:#36e156;color:#fff;font-weight:700;border-radius:5px;padding:6px 12px;font-size:17px;">
            {{ cat.full }}
          </div>
          <div class="status-pill"
               data-status="limited"
               style="background:#ffe346;color:#fff;font-weight:700;border-radius:5px;padding:6px 12px;font-size:17px;">
            {{ cat.limited }}
          </div>
          <div class="status-pill"
               data-status="none"
               style="background:#ff3939;color:#fff;font-weight:700;border-radius:5px;padding:6px 12px;font-size:17px;">
            {{ cat.none }}
          </div>
        </div>
        <div style="color:#fff;font-size:1em;text-align:center;">
          Active Injury: <b style="color:#fff;">{{ cat.active_injury }}</b>
        </div>
      </div>
    {% endfor %}
  </div>
</div>


<h3 style="font-size:35px;">Organization Dashboard</h3>

<!-- Filters Form -->
<form class="filter-form" onsubmit="return false;" aria-label="Filter players and injuries">
  <label for="filterCategory">Category:</label>
  <select id="filterCategory" name="category" aria-describedby="filterCategoryHelp">
    <option value="all">All Categories</option>
    <option value="boys_under-15">Boys under 15</option>
    <option value="boys_under-19">Boys under 19</option>
    <option value="men_under-23">Men Under 23</option>
    <option value="men_senior">Men Senior</option>
  </select>

  {% comment %} <label for="filterGender">Gender:</label>
  <select id="filterGender" name="gender" aria-describedby="filterGenderHelp">
    <option value="all">All Genders</option>
    <option value="M">Male</option>
    <option value="F">Female</option>
    <option value="O">Other</option>
  </select> {% endcomment %}

  {% comment %} <label for="searchInput">Search:</label>
  <input type="search" id="searchInput" placeholder="Player or Injury name..." aria-label="Search player or injury names" /> {% endcomment %}

  <button type="button" id="resetFilters" aria-label="Reset filters">Reset</button>
</form>

<!-- Cards -->
<div class="cards" role="region" aria-label="Summary statistics">
  <div class="card total-injuries-card" aria-live="polite" aria-atomic="true">
    <h3>Total Injuries</h3>
    <p >{{ total_injuries_count }}</p>
  </div>
  <div class="card active-injuries-card" aria-live="polite" aria-atomic="true">
    <h3>Active Injuries</h3>
    <p id="activeInjuriesCount">{{ active_injuries_count }}</p>
  </div>
  <div class="card recovered-injuries-card" aria-live="polite" aria-atomic="true">
    <h3>Recovered Injuries</h3>
    <p >{{ recovered_injuries_count }}</p>
  </div>
</div>

<!-- Participation Types -->
<section aria-labelledby="campSectionTitle" class="camp-section">
  <h3 id="campSectionTitle" class="camp-section__title">Camp / Tournament</h3>

  <!-- Year tabs -->
  <div class="camp-tabs" id="campYearTabs">
    {% for year, items in camps_by_year.items %}
      <button type="button"
              class="camp-tabs__tab {% if forloop.first %}camp-tabs__tab--active{% endif %}"
              data-year="{{ year }}">
        {{ year }}
      </button>
    {% endfor %}
  </div>

  <!-- Lists per year -->
  {% for year, items in camps_by_year.items %}
    <ul class="camp-list camp-list--year {% if not forloop.first %}camp-list--hidden{% endif %}"
        data-year-panel="{{ year }}">
      {% for pt in items %}
        <li class="camp-list__item" data-role="{{ pt.role|default:'N/A' }}">
          <div class="camp-list__info">
            <span class="camp-list__name">{{ forloop.counter }}.  {{ pt.name }}</span>
          </div>

          <div class="camp-list__meta">
            <span class="camp-list__badge camp-list__badge--players tooltip-trigger"
                  data-tooltip="{{ pt.player_names|default:'No players' }}">
              {{ pt.player_count }} athletes
            </span>

            <span class="camp-list__badge camp-list__badge--staff tooltip-trigger"
                  data-tooltip="{{ pt.staff_names|default:'No staff' }}">
              {{ pt.staff_count }} staff
            </span>

            <a href="{% url 'organization_camp_detail' camp_id=pt.id %}"
               target="_blank"
               class="camp-list__link">
              View details
            </a>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endfor %}
</section>

<!-- Search & Date Filters (affects Player Details + Active Injuries) -->
<!-- Search & Filter Section -->
<section aria-labelledby="searchFilterTitle">
  <h3 id="searchFilterTitle">Search & Filters</h3>

  <form class="filter-form" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    
    <!-- Search Input -->
    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 200px;">
      <label for="searchInput" style="font-weight: 600; color: #333; font-size: 14px;">Search:</label>
      <input type="search"
             id="searchInput"
             name="search"
             placeholder="Search player or injury..."
             aria-label="Search active injuries"
             style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;" />
    </div>

    <!-- Date Filter -->
    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 180px;">
      <label for="dateFilterType" style="font-weight: 600; color: #333; font-size: 14px;">Date Filter:</label>
      <select id="dateFilterType" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
        <option value="none">All time</option>
        <option value="last_3">Last 3 months</option>
        <option value="last_6">Last 6 months</option>
        <option value="season">Season</option>
        <option value="custom">Custom range</option>
      </select>
    </div>

    <!-- Season Dropdown -->
    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 160px;">
      <label for="seasonSelect" style="font-weight: 600; color: #333; font-size: 14px;">Season:</label>
      <select id="seasonSelect" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; display: none;">
        <option value="">Select season</option>
        <option value="2022-2023">2022‚Äì2023</option>
        <option value="2023-2024">2023‚Äì2024</option>
        <option value="2024-2025">2024‚Äì2025</option>
        <option value="2025-2026">2025‚Äì2026</option>
      </select>
    </div>

    <!-- Custom Date Range -->
    <div id="customRange" style="display: none; gap: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
      <label for="startDate" style="font-weight: 600; color: #333; font-size: 14px; white-space: nowrap;">From:</label>
      <input type="date" id="startDate" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;" />
      <label for="endDate" style="font-weight: 600; color: #333; font-size: 14px; white-space: nowrap;">To:</label>
      <input type="date" id="endDate" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;" />
    </div>

    <!-- Reset Button -->
    <button type="button" id="resetFilters" 
            style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
      Reset Filters
    </button>
  </form>
</section>




<!-- Active Injuries Table -->
<section aria-labelledby="activeInjuriesTitle">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h3 id="activeInjuriesTitle">Active Injuries</h3>
    <div id="injuriesCounter" style="font-weight: 600; color: #36a9e1; font-size: 16px; min-width: 180px;">
      Showing <span id="totalInjuriesCount">{{ active_injuries_count }}</span> active injuries
    </div>
  </div>
  
  <table id="activeInjuriesTable" role="grid" aria-describedby="activeInjuriesDesc">
    <caption id="activeInjuriesDesc" class="sr-only">
      List of currently active injuries
    </caption>
    <thead>
      <tr>
        <th scope="col">No</th>
        <th scope="col">Player</th>
        <th scope="col">Title</th>
        <th scope="col">Severity Rating</th>
        <th scope="col">Status</th>
        <th scope="col">Injury Date</th>
      </tr>
    </thead>
    <tbody>
      {% for injury in active_injuries %}
      <tr
        data-date="{{ injury.injury_date|date:'Y-m-d' }}"
        data-status="{{ injury.status }}">
        <td class="player-no">{{ forloop.counter }}</td>
        <td class="player-name">{{ injury.player.name }}</td>
        <td class="injury-name">
          <a href="{% url 'organization_injury_detail' injury.id %}">
            {{ injury.name }}
          </a>
        </td>
        <td>{{ injury.severity_rating|default:"-" }}</td>
        <td>
          <span class="status-badge {% if injury.status == 'open' %}status-open{% elif injury.status == 'closed' %}status-closed{% endif %}">
            {{ injury.get_status_display|default:"-" }}
          </span>
        </td>
        <td>{{ injury.injury_date }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" style="text-align:center; font-style: italic;">
          No active injuries found.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>




<!-- Player Details Table -->
{% comment %} <section aria-labelledby="playerDetailsTitle">
  <h3 id="playerDetailsTitle">Player Details</h3>
  <table id="playerDetailsTable" role="grid" aria-describedby="playerDetailsDesc">
    <caption id="playerDetailsDesc" class="sr-only">List of players with participation types and injury notes</caption>
    <thead>
      <tr>
        <th scope="col">No</th>
        <th scope="col">Name</th>
        <th scope="col">Category</th>
        <th scope="col">Role</th>
        <th scope="col">Participation Status</th>
      </tr>
    </thead>
    <tbody>
      {% for player in players %}
      <tr data-category="{{ player.age_category|default:'none' }}" data-gender="{{ player.gender|default:'none' }}">
        <td class="player-name">{{ forloop.counter }}</td>
        <td class="player-name">{{ player.name }}</td>
        <td class="player-name">{{ player.age_category }}</td>
        <td class="player-name">{{ player.role }}</td>
        <td class="player-name">{{ player.player_status}}</td>
        <!-- <td> {% for camp in player.camps.all %}
                {{ camp.name }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                No camps
              {% endfor %}
        </td>
        <td>
          {% if player.injuries.all %}
            <ul style="padding-left: 16px; margin: 0;">
              {% for injury in player.injuries.all %}
                {% if injury.notes %}
                <li class="note">
                  <strong>Injury:</strong> {{ injury.name|default:"N/A" }}<br />
                  {{ injury.notes|linebreaksbr }}
                </li>
                {% else %}
                <li class="note"><em>No notes for injury '{{ injury.name|default:"N/A" }}'</em></li>
                {% endif %}
              {% endfor %}
            </ul>
          {% else %}
            <em>No injuries/notes</em>
          {% endif %}
        </td> -->
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section> {% endcomment %}

<section aria-labelledby="playerFiltersTitle" style="margin-bottom: 25px;">
  <h3 id="playerFiltersTitle" class="sr-only">Player Filters</h3>
  
  <div class="filter-controls" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <div style="display: flex; gap: 30px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
      
      <!-- Participation Status Filter -->
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <label style="font-weight: 600; color: #333; font-size: 14px;">Participation Status:</label>
        <div class="status-filters" style="display: flex; gap: 8px;">
          <button class="filter-btn active" data-status="all" style="background: #36a9e1; color: white; padding: 8px 16px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            All
          </button>
          <button class="filter-btn" data-status="full" style="background: #36e156; color: white; padding: 8px 16px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            Full Participation
          </button>
          <button class="filter-btn" data-status="limited" style="background: #ffe346; color: #333; padding: 8px 16px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            Limited
          </button>
          <button class="filter-btn" data-status="no" style="background: #ff3939; color: white; padding: 8px 16px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            No Participation
          </button>
        </div>
      </div>

      <!-- Year Range Filter -->
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <label style="font-weight: 600; color: #333; font-size: 14px;">Created Year:</label>
        <div class="year-filters" style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="filter-btn-year active" data-year="all" style="background: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
            All Years
          </button>
          <!-- Dynamic year buttons will be added by JavaScript -->
        </div>
      </div>

      <!-- Results Counter -->
      <div id="resultsCounter" style="font-weight: 600; color: #36a9e1; font-size: 16px; min-width: 150px;">
        Showing <span id="totalCount">0</span> players
      </div>
    </div>
  </div>
</section>

<!-- Player Details Table (Your existing table) -->
<section aria-labelledby="playerDetailsTitle">
  <h3 id="playerDetailsTitle">Player Status</h3>
  <table id="playerDetailsTable" role="grid" aria-describedby="playerDetailsDesc">
    <caption id="playerDetailsDesc" class="sr-only">
      List of players with category, role and participation status
    </caption>
    <thead>
      <tr>
        <th scope="col">No</th>
        <th scope="col">Name</th>
        <th scope="col">Created</th>
        <th scope="col">Category</th>
        <th scope="col">Role</th>
        <th scope="col">Participation Status</th>
      </tr>
    </thead>
    <tbody>
      {% for player in players %}
      <tr data-category="{{ player.age_category|default:'none' }}"
          data-gender="{{ player.gender|default:'none' }}"
          data-status="{% if player.player_status == 'full participation' %}full{% elif player.player_status == 'limited participation' %}limited{% elif player.player_status == 'no participation' %}no{% else %}other{% endif %}"
          data-year="{{ player.created_at|date:'Y' }}"
          data-year-range="{{ player.created_at|date:'Y' }}-{{ player.created_at|date:'Y'|add:1 }}">
        <td class="row-number">{{ forloop.counter }}</td>
        <td class="player-name">{{ player.name }}</td>
        <td>{{ player.created_at|date:"d-m-Y" }}</td>
        <td>{{ player.age_category }}</td>
        <td>{{ player.role }}</td>
        <td>
          {% if player.player_status == 'full participation' %}
            <span class="status-badge full" style="background:#36e156;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.85rem;font-weight:600;">
              FULL PARTICIPATION
            </span>
          {% elif player.player_status == 'limited participation' %}
            <span class="status-badge limited" style="background:#ffe346;color:#333;padding:4px 10px;border-radius:12px;font-size:0.85rem;font-weight:600;">
              LIMITED PARTICIPATION
            </span>
          {% elif player.player_status == 'no participation' %}
            <span class="status-badge no" style="background:#ff3939;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.85rem;font-weight:600;">
              NO PARTICIPATION
            </span>
          {% else %}
            <span style="color:#666;">{{ player.player_status|default:"N/A" }}</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>


<h3>Recent Activity Logs</h3>
<table>
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Type</th>
      <th>Actor/User</th>
      <th>Subject</th>
      <th>Action / Description</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    {% for log in activity_logs %}
    <tr>
      <td>
        {% if log.timestamp %}
          {{ log.timestamp|date:"Y-m-d H:i:s" }}
        {% elif log.created_at %}
          {{ log.created_at|date:"Y-m-d H:i:s" }}
        {% endif %}
      </td>

      <td>
        {% if log.log_type == 'medical' %}
          Medical Document Log
        {% elif log.log_type == 'injury' %}
          Injury Log
        {% elif log.log_type == 'player' %}
          Player Log
        {% else %}
          Unknown
        {% endif %}
      </td>

      <td>
        {% if log.log_type == 'medical' %}
    {{ log.user.username|default:"Unknown User" }}
  {% elif log.log_type == 'injury' or log.log_type == 'player' %}
    {{ log.actor.username|default:"Unknown User" }}
  {% else %}
    Unknown User
  {% endif %}
      </td>

      <td>
        {% if log.log_type == 'medical' %}
          {{ log.player.name }} - Document: {{ log.document }}
        {% elif log.log_type == 'injury' %}
          {{ log.injury.player.name }} - Injury: {{ log.injury.name }}
        {% elif log.log_type == 'player' %}
          {{ log.player.name }}
        {% else %}
          N/A
        {% endif %}
      </td>

      <td>
        {% if log.log_type == 'medical' %}
          {{ log.activity_type }}
        {% elif log.log_type == 'injury' %}
          {{ log.action }}
        {% elif log.log_type == 'player' %}
          {{ log.action }}
        {% else %}
          N/A
        {% endif %}
      </td>

      <td>
        {% if log.log_type == 'medical' %}
          {{ log.description|default:"-" }}
        {% elif log.log_type == 'injury' %}
          {{ log.details|default:"-" }}
        {% elif log.log_type == 'player' %}
          {{ log.details|default:"-" }}
        {% else %}
          -
        {% endif %}
      </td>
    </tr>
    {% empty %}
      <tr><td colspan="6" style="text-align:center;">No activity logs found.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- JavaScript for filtering -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ========================================
  // 1. TABLE FILTERING (players + injuries)
  // ========================================
  const filterCategory = document.getElementById('filterCategory');
  const filterGender = document.getElementById('filterGender');
  const searchInput = document.getElementById('searchInput');
  const resetBtn = document.getElementById('resetFilters');

  const playerRows = Array.from(document.querySelectorAll('#playerDetailsTable tbody tr'));
  const injuryRows = Array.from(
    document.querySelectorAll('#activeInjuriesTable tbody tr')
  ).filter(r => r.querySelector('.player-name'));
  const totalInjuriesCountEl = document.getElementById('totalInjuriesCount');
  const activeInjuriesCountEl = document.getElementById('activeInjuriesCount');
  const participationListItems = Array.from(document.querySelectorAll('#participationList li'));

  function normalize(text) {
    return (text || '').toString().toLowerCase().trim();
  }

  function filterTables() {
    const selectedCategory = normalize(filterCategory?.value || 'all');
    const selectedGender = normalize(filterGender?.value || 'all');
    const searchTerm = normalize(searchInput?.value || '');

    // Filter player rows
    let visiblePlayers = 0;
    playerRows.forEach(row => {
      const cat = normalize(row.getAttribute('data-category'));
      const gender = normalize(row.getAttribute('data-gender'));
      const playerName = normalize(row.querySelector('.player-name')?.textContent || '');
      const notesCell = row.querySelector('td:nth-child(3)');
      const notesText = normalize(notesCell ? notesCell.textContent : '');

      const categoryMatch = (selectedCategory === 'all' || cat === selectedCategory);
      const genderMatch = (selectedGender === 'all' || gender === selectedGender);
      const searchMatch = !searchTerm || playerName.includes(searchTerm) || notesText.includes(searchTerm);

      if (categoryMatch && genderMatch && searchMatch) {
        row.style.display = '';
        visiblePlayers++;
      } else {
        row.style.display = 'none';
      }
    });

    // Filter injury rows
    let visibleInjuries = 0;
    injuryRows.forEach(row => {
      const cat = normalize(row.getAttribute('data-category'));
      const gender = normalize(row.getAttribute('data-gender'));
      const playerName = normalize(row.querySelector('.player-name')?.textContent || '');
      const injuryName = normalize(row.querySelector('.injury-name')?.textContent || '');

      const categoryMatch = (selectedCategory === 'all' || cat === selectedCategory);
      const genderMatch = (selectedGender === 'all' || gender === selectedGender);
      const searchMatch = !searchTerm || playerName.includes(searchTerm) || injuryName.includes(searchTerm);

      if (categoryMatch && genderMatch && searchMatch) {
        row.style.display = '';
        visibleInjuries++;
      } else {
        row.style.display = 'none';
      }
    });

    // Update counts (cards have <p> inside)
    if (totalInjuriesCountEl) {
      const p = totalInjuriesCountEl.querySelector('p');
      if (p) p.textContent = visibleInjuries;
    }
    if (activeInjuriesCountEl) {
      const p = activeInjuriesCountEl.querySelector('p');
      if (p) p.textContent = visibleInjuries;
    }

    // Update participation counts
    participationListItems.forEach(li => {
      const role = normalize(li.getAttribute('data-role'));
      const count = playerRows.filter(row => {
        if (row.style.display === 'none') return false;
        const rowRole = normalize(row.querySelector('td:nth-child(2)')?.textContent || '');
        const cat = normalize(row.getAttribute('data-category'));
        const gender = normalize(row.getAttribute('data-gender'));
        return (selectedCategory === 'all' || cat === selectedCategory) &&
               (selectedGender === 'all' || gender === selectedGender) &&
               (role === 'n/a' ? (rowRole === '' || rowRole === 'n/a') : rowRole.includes(role));
      }).length;

      const countSpan = li.querySelector('.count');
      if (countSpan) countSpan.textContent = count;
    });
  }

  if (filterCategory) filterCategory.addEventListener('change', filterTables);
  if (filterGender) filterGender.addEventListener('change', filterTables);
  if (searchInput)  searchInput.addEventListener('input', filterTables);
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (filterCategory) filterCategory.value = 'all';
      if (filterGender)  filterGender.value = 'all';
      if (searchInput)   searchInput.value = '';
      filterTables();
    });
  }

  // ========================================
  // 2. CATEGORY CARDS (top blue cards)
  // ========================================
  const CATEGORY_PLAYERS = {{ category_players|safe }};

  // Tooltip for category cards
  let catTooltip = document.createElement('div');
  catTooltip.className = 'custom-tooltip';
  document.body.appendChild(catTooltip);

  function showCatTooltip(target, text) {
    if (!text || text === 'No players') return;
    catTooltip.textContent = text;
    const rect = target.getBoundingClientRect();
    catTooltip.style.left = (window.scrollX + rect.left) + 'px';
    catTooltip.style.top  = (window.scrollY + rect.bottom + 5) + 'px';
    catTooltip.style.display = 'block';
  }

  function hideCatTooltip() {
    catTooltip.style.display = 'none';
  }

  document.querySelectorAll('.status-pill').forEach(pill => {
    pill.style.cursor = 'help';
    pill.title = 'Hover for player list';

    pill.addEventListener('mouseenter', e => {
      const card = e.target.closest('.category-card');
      if (!card) return;
      const ageCat = card.getAttribute('data-age-category');
      const players = CATEGORY_PLAYERS[ageCat] || [];
      const text = players.length ? players.slice(0, 8).join('\n') : 'No players';
      showCatTooltip(e.target, text);
    });

    pill.addEventListener('mouseleave', hideCatTooltip);
  });

  document.querySelectorAll('.category-card').forEach(card => {
    card.style.transition = 'transform 0.2s ease';
    card.style.cursor = 'pointer';

    card.addEventListener('mouseenter', () => {
      card.style.transform = 'scale(1.02)';
    });

    card.addEventListener('mouseleave', () => {
      card.style.transform = 'scale(1)';
    });

    card.addEventListener('click', e => {
      e.stopPropagation();
      const ageCat = card.getAttribute('data-age-category');
      if (!ageCat) return;
      const url = "{% url 'players_by_category' %}?age_category=" + encodeURIComponent(ageCat);
      window.open(url, '_blank');
    });
  });

  // ========================================
  // 3. CAMP / TOURNAMENT YEAR TABS + TOOLTIP
  // ========================================
  const yearTabs  = document.querySelectorAll('.camp-tabs__tab, .year-tab');
  const yearPanels = document.querySelectorAll('.camp-list--year, .year-panel');

  yearTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const year = tab.dataset.year || tab.getAttribute('data-year');

      yearTabs.forEach(t => t.classList.remove('camp-tabs__tab--active', 'active'));
      tab.classList.add('camp-tabs__tab--active', 'active');

      yearPanels.forEach(p => {
        const panelYear = p.dataset.yearPanel || p.getAttribute('data-year-panel');
        p.classList.toggle('camp-list--hidden', panelYear !== year);
        p.classList.toggle('hidden',          panelYear !== year);
      });
    });
  });

  // Shared tooltip for camp counts (athletes / staff)
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip-box';
  document.body.appendChild(tooltip);

  function showTooltip(el) {
    const text = el.getAttribute('data-tooltip');
    if (!text) return;
    tooltip.textContent = text;
    const rect = el.getBoundingClientRect();
    tooltip.style.left = window.scrollX + rect.left + 'px';
    tooltip.style.top  = window.scrollY + rect.bottom + 6 + 'px';
    tooltip.style.display = 'block';
  }

  function hideTooltipBox() {
    tooltip.style.display = 'none';
  }

  document.querySelectorAll('.tooltip-trigger').forEach(el => {
    el.addEventListener('mouseenter', () => showTooltip(el));
    el.addEventListener('mouseleave', hideTooltipBox);
  });

  // ========================================
  // 4. INITIAL RUN + DEBUG
  // ========================================
  filterTables();
  console.log('‚úÖ Dashboard JS initialized');
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput    = document.getElementById('searchInput');
  const resetBtn       = document.getElementById('resetFilters');
  const dateFilterType = document.getElementById('dateFilterType');
  const seasonSelect   = document.getElementById('seasonSelect');
  const customRange    = document.getElementById('customRange');
  const startDateInput = document.getElementById('startDate');
  const endDateInput   = document.getElementById('endDate');

  // Card elements with proper IDs
  const totalInjuriesCard = document.getElementById('totalInjuriesCount');
  const activeInjuriesCard = document.getElementById('activeInjuriesCount');
  const recoveredInjuriesCard = document.getElementById('recoveredInjuriesCount');

  const injuryRows = Array.from(
    document.querySelectorAll('#activeInjuriesTable tbody tr')
  ).filter(r => r.querySelector('.player-name'));
  const playerRows = Array.from(
    document.querySelectorAll('#playerDetailsTable tbody tr')
  );

  function normalize(text) {
    return (text || '').toString().toLowerCase().trim();
  }

  function parseYMD(str) {
    if (!str) return null;
    const parts = str.split('-');
    if (parts.length !== 3) return null;
    const [y, m, d] = parts.map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function getDateBounds() {
    const now = new Date();
    let from = null;
    let to = null;

    switch (dateFilterType?.value) {
      case 'last_3':
        from = new Date(now);
        from.setMonth(from.getMonth() - 3);
        break;
      case 'last_6':
        from = new Date(now);
        from.setMonth(from.getMonth() - 6);
        break;
      case 'season':
        if (seasonSelect?.value) {
          const [y1, y2] = seasonSelect.value.split('-').map(Number);
          from = new Date(y1, 3, 1);
          to = new Date(y2, 2, 31);
        }
        break;
      case 'custom':
        from = parseYMD(startDateInput?.value);
        to = parseYMD(endDateInput?.value);
        break;
    }
    return { from, to };
  }

  function dateMatches(rowDateStr, bounds) {
    if (!bounds.from && !bounds.to) return true;
    const d = parseYMD(rowDateStr);
    if (!d) return false;
    if (bounds.from && d < bounds.from) return false;
    if (bounds.to && d > bounds.to) return false;
    return true;
  }

  // ‚úÖ PERFECT: Exact status counting
  function countVisibleInjuriesByStatus() {
    const q = normalize(searchInput?.value || '');
    const bounds = getDateBounds();
    
    let totalVisible = 0;
    let openCount = 0;    // Active = open
    let closedCount = 0;  // Recovered = closed

    injuryRows.forEach(row => {
      // Get row data
      const playerEl = row.querySelector('.player-name');
      const injuryEl = row.querySelector('.injury-name');
      const rowDate = row.getAttribute('data-date') || '';
      const statusAttr = row.getAttribute('data-status') || '';
      
      // Status detection - PRIORITY ORDER:
      // 1. data-status attribute (most reliable)
      // 2. status badge text
      // 3. status cell text
      let rowStatus = '';
      const statusEl = row.querySelector('.status-badge, [class*="status"], td:last-child');
      if (statusEl) {
        rowStatus = normalize(statusEl.textContent || statusEl.getAttribute('data-status') || '');
      }

      // Check if row matches search + date filters
      const rowText = normalize(
        (playerEl ? playerEl.textContent : '') + ' ' +
        (injuryEl ? injuryEl.textContent : '')
      );

      const searchMatch = !q || rowText.includes(q);
      const dateMatch = dateMatches(rowDate, bounds);

      if (searchMatch && dateMatch) {
        totalVisible++;
        
        // ‚úÖ EXACT STATUS CHECKING
        if (statusAttr === 'open' || statusAttr === 'active' || 
            rowStatus.includes('open') || rowStatus.includes('active')) {
          openCount++;      // Active injuries
        } else if (statusAttr === 'closed' || statusAttr === 'recovered' || 
                   rowStatus.includes('closed') || rowStatus.includes('recovered')) {
          closedCount++;    // Recovered injuries
        }
      }
    });

    return { 
      total: totalVisible, 
      active: openCount,    // Only OPEN injuries
      recovered: closedCount // Only CLOSED injuries
    };
  }

  function updateInjuryCards() {
    const counts = countVisibleInjuriesByStatus();
    
    // Update all 3 cards
    if (totalInjuriesCard) totalInjuriesCard.textContent = counts.total;
    if (activeInjuriesCard) activeInjuriesCard.textContent = counts.active;
    if (recoveredInjuriesCard) recoveredInjuriesCard.textContent = counts.recovered;
    
    // Debug (remove in production)
    console.log('üìä Counts:', {
      total: counts.total,
      active_open: counts.active,
      recovered_closed: counts.recovered
    });
  }

  function applyFilters() {
    const q = normalize(searchInput ? searchInput.value : '');
    const bounds = getDateBounds();

    // Filter injuries table rows
    injuryRows.forEach(row => {
      const playerEl = row.querySelector('.player-name');
      const injuryEl = row.querySelector('.injury-name');
      const rowDate = row.getAttribute('data-date') || '';

      const rowText = normalize(
        (playerEl ? playerEl.textContent : '') + ' ' +
        (injuryEl ? injuryEl.textContent : '')
      );

      const searchMatch = !q || rowText.includes(q);
      const dateMatch = dateMatches(rowDate, bounds);

      row.style.display = (searchMatch && dateMatch) ? '' : 'none';
    });

    // Filter players table rows
    playerRows.forEach(row => {
      const nameEl = row.querySelector('.player-name');
      const playerName = normalize(nameEl ? nameEl.textContent : '');
      const searchMatch = !q || playerName.includes(q);
      row.style.display = searchMatch ? '' : 'none';
    });

    // Update all 3 cards
    updateInjuryCards();
  }

  // Event listeners (unchanged)
  if (dateFilterType) {
    dateFilterType.addEventListener('change', () => {
      if (dateFilterType.value === 'season') {
        seasonSelect.style.display = 'inline-block';
        customRange.style.display = 'none';
      } else if (dateFilterType.value === 'custom') {
        seasonSelect.style.display = 'none';
        customRange.style.display = 'flex';
      } else {
        seasonSelect.style.display = 'none';
        customRange.style.display = 'none';
      }
      applyFilters();
    });
  }

  [seasonSelect, startDateInput, endDateInput, searchInput].forEach(el => {
    if (el) el.addEventListener('change', applyFilters);
  });
  if (searchInput) searchInput.addEventListener('input', applyFilters);

  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (searchInput) searchInput.value = '';
      if (dateFilterType) dateFilterType.value = 'none';
      if (seasonSelect) { seasonSelect.value = ''; seasonSelect.style.display = 'none'; }
      if (startDateInput) startDateInput.value = '';
      if (endDateInput) endDateInput.value = '';
      if (customRange) customRange.style.display = 'none';

      injuryRows.forEach(row => row.style.display = '');
      playerRows.forEach(row => row.style.display = '');
      updateInjuryCards();
      applyFilters();
    });
  }

  // Initial run
  applyFilters();
});


</script>


{% comment %} For player filter table {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('#playerDetailsTable tbody tr');
  const statusBtns = document.querySelectorAll('.filter-btn');
  const yearBtns = document.querySelectorAll('.filter-btn-year');
  const totalCountEl = document.getElementById('totalCount');
  
  let currentStatusFilter = 'all';
  let currentYearFilter = 'all';
  
  // Generate Year Range Buttons (2021-2022, 2022-2023, etc.)
  function createYearButtons() {
    const yearContainer = document.querySelector('.year-filters');
    const years = {};
    
    // Collect all years from data
    rows.forEach(row => {
      const year = row.dataset.year;
      if (year) years[year] = true;
    });
    
    // Clear existing year buttons (except All)
    const existingBtns = yearContainer.querySelectorAll('.filter-btn-year:not([data-year="all"])');
    existingBtns.forEach(btn => btn.remove());
    
    // Create year range buttons
    Object.keys(years).sort((a, b) => b - a).forEach(year => {
      const range = `${year}-${parseInt(year) + 1}`;
      const btn = document.createElement('button');
      btn.className = 'filter-btn-year';
      btn.dataset.year = range;
      btn.textContent = range;
      btn.style.cssText = `
        background: #e9ecef; color: #495057; padding: 8px 12px; 
        border: none; border-radius: 20px; font-weight: 600; cursor: pointer; 
        font-size: 13px; transition: all 0.3s; border: 2px solid transparent;
      `;
      yearContainer.appendChild(btn);
    });
  }
  
  // Filter function
  function filterRows() {
    let visibleCount = 0;
    
    rows.forEach(row => {
      const statusMatch = currentStatusFilter === 'all' || row.dataset.status === currentStatusFilter;
      const yearMatch = currentYearFilter === 'all' || row.dataset.yearRange === currentYearFilter;
      
      if (statusMatch && yearMatch) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // Update counter and row numbers
    totalCountEl.textContent = visibleCount;
    updateRowNumbers();
    
    // Update active buttons
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.filter-btn-year').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-status="${currentStatusFilter}"]`).classList.add('active');
    document.querySelector(`[data-year="${currentYearFilter}"]`).classList.add('active');
  }
  
  // Update row numbers
  function updateRowNumbers() {
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    visibleRows.forEach((row, index) => {
      row.querySelector('.row-number').textContent = index + 1;
    });
  }
  
  // Status filter event listeners
  statusBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      currentStatusFilter = this.dataset.status;
      filterRows();
    });
  });
  
  // Dynamic year filter event listeners (add after creating buttons)
  function attachYearListeners() {
    document.querySelectorAll('.filter-btn-year:not([data-year="all"])').forEach(btn => {
      btn.addEventListener('click', function() {
        currentYearFilter = this.dataset.year;
        filterRows();
      });
    });
  }
  
  // Initialize
  createYearButtons();
  attachYearListeners();
  filterRows();
  
  // Hover effects
  document.querySelectorAll('.filter-btn, .filter-btn-year').forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      if (!this.classList.contains('active')) {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      }
    });
    btn.addEventListener('mouseleave', function() {
      if (!this.classList.contains('active')) {
        this.style.transform = '';
        this.style.boxShadow = '';
      }
    });
  });
});
</script>




{% endblock %}