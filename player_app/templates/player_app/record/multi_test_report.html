{% extends "player_app/organization/base.html" %} {% load static %} 
{% block title %}Player Record{% endblock %} {% block extra_head %}
<style>
  :root {
    --color-primary: #0f172a;
    --color-secondary: #007cf0;
    --color-accent: #00dfd8;
    --color-background: #f4f6fa;
    --color-card-bg: #fff;
    --color-text-dark: #1a202c;
    --color-text-light: #fff;
    --color-border-light: #d1d5db;
    --color-border-dark: #e5e7eb;
    --color-highlight: #d9f7be;
    --color-input-bg: #f9fafb;
    --color-dark-green: #1b4d2e;
    --color-orange: #f59e0b;
    --color-gray: #363636;
    --color-light-gray: #f8fafc;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--color-background);
    line-height: 1.6;
  }
  .welcome-section {
    height: 260px;
    background: linear-gradient(
      to right,
      var(--color-secondary),
      var(--color-accent)
    );
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 0 var(--space-xl);
  }
  .welcome-section h1 {
    font-size: 32px;
    font-weight: 600;
    color: var(--color-text-light);
    margin: 0;
  }
  .main-card {
    max-width: 1200px;
    margin: -80px auto var(--space-xl) auto;
    background-color: var(--color-card-bg);
    border-radius: 12px;
    padding: var(--space-xl);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    position: relative;
    z-index: 10;
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
  }
  .import-button {
    display: inline-flex;
    align-items: center;
    background-color: var(--color-primary);
    color: var(--color-text-light);
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    text-decoration: none;
  }
  .import-button:hover {
    background-color: #1e293b;
  }
  .form-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
    margin-bottom: var(--space-xl);
  }
  .form-fields {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    padding: var(--space-xl);
    background-color: var(--color-card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--color-border-dark);
  }
  .form-fields label {
    font-size: 14px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #1f2937;
  }
  .input {
    padding: 0.75rem 1rem;
    font-size: 15px;
    font-weight: 500;
    border: 1px solid var(--color-border-light);
    border-radius: 12px;
    background-color: var(--color-input-bg);
    transition: all 0.2s ease-in-out;
    color: #111827;
    width: 100%;
  }
  select.input {
    width: 100%;
  }
  .input:focus,
  select.input:focus {
    outline: none;
    border-color: #2563eb;
    background-color: var(--color-card-bg);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
  }
  button {
    background-color: var(--color-primary);
    color: var(--color-text-light);
    font-weight: 700;
    font-size: 15px;
    padding: 0.9rem;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    width: 100%;
  }
  button:hover {
    background-color: #1e293b;
    transform: translateY(-1px);
  }
  .player-info-section {
    margin-top: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    background-color: var(--color-dark-green);
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    padding: var(--space-md);
  }
  .player-info-title {
    color: var(--color-text-light);
    text-align: center;
    font-style: italic;
    font-weight: 700;
    margin: 0;
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .player-info-card {
    border-top: 15px solid var(--color-orange);
    border-bottom: 15px solid var(--color-orange);
    color: var(--color-text-light);
    border-radius: 6px;
    overflow: hidden;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: var(--space-md);
    flex-wrap: wrap;
  }
  .player-photo {
    background-color: var(--color-dark-green);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-height: 176px;
    width: 170px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .player-info-table {
    flex-grow: 1;
    border-collapse: collapse;
    font-size: 14px;
    color: var(--color-text-light);
    margin-left: 1rem;
  }
  .player-info-table th,
  .player-info-table td {
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.5rem;
    text-align: left;
  }
  .player-info-table th {
    font-weight: normal;
    background-color: #114224;
    text-align: center;
    width: 40%;
  }
  .coach-name {
    align-self: flex-start;
    padding: var(--space-md);
    background-color: #114224;
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 150px;
    height: 145px;
    text-align: center;
    font-size: 14px;
  }
  .chart-container {
    width: 85%;
    margin: 2rem auto;
  }
  .chart-legend {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 8px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
  }
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 2rem;
  }
  table.stats-table {
    width: 100%;
    border-collapse: collapse;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin-top: 1rem;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  table.stats-table thead {
    background-color: #0f172a;
    color: #fff;
  }
  table.stats-table th,
  table.stats-table td {
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: middle;
    font-size: 14px;
  }
  table.stats-table tbody tr:hover {
    background-color: #f9fafb;
  }
  .right-align {
    text-align: right;
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }
  .date-filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .date-filter-group input[type="radio"] {
    margin-right: 0.5rem;
  }
  .select-wrapper {
    display: flex;
    flex-direction: column;
  }
  .button-wrapper {
    display: flex;
    flex-direction: column;
  }
  @media (max-width: 900px) {
    .form-container,
    .chart-container,
    .player-info-card {
      flex-direction: column;
    }
    .player-info-table {
      margin-left: 0;
      margin-top: 1rem;
    }
  }

  .card-header {
    background: linear-gradient(135deg, #ffffffff, #ffffffff);
    border-radius: 16px 16px 0 0;
    padding: 16px 24px;
  }

  .report-settings-card {
    background: #ffffff;
    color: #333;
    border-radius: 12px;
    padding: 8px 12px;
    min-width: 260px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }

  .status-pill {
    background: #e3f2fd;
    color: #0d47a1;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    font-weight: 600;
  }

  .clear-link {
    font-size: 11px;
    color: #d32f2f;
    text-decoration: none;
  }

  .settings-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 4px;
  }

  .pill {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, 0.06);
    white-space: nowrap;
  }

  .pill-blue {
    background: #e3f2fd;
    color: #0d47a1;
  }
  .pill-green {
    background: #e8f5e9;
    color: #1b5e20;
  }
  .pill-purple {
    background: #f3e5f5;
    color: #4a148c;
  }

  .settings-edit-link {
    display: inline-block;
    font-size: 11px;
    color: #1976d2;
    text-decoration: underline;
  }

  .tests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--color-light-gray);
    border-radius: 12px;
    border: 1px solid var(--color-border-light);
  }
  .test-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem;
    border: 2px solid var(--color-border-light);
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .test-checkbox:hover {
    border-color: var(--color-secondary);
    transform: translateY(-2px);
  }
  .test-checkbox.checked {
    border-color: var(--color-secondary);
    background: linear-gradient(
      135deg,
      var(--color-secondary),
      var(--color-accent)
    );
    color: white;
  }
  .test-checkbox input[type="checkbox"] {
    width: 22px;
    height: 22px;
    accent-color: white;
    transform: scale(1.2);
  }
  .test-label {
    font-weight: 600;
    cursor: pointer;
    flex: 1;
    font-size: 14px;
  }
  .selected-count {
    background: linear-gradient(
      135deg,
      var(--color-secondary),
      var(--color-accent)
    );
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 25px;
    font-weight: 700;
    margin-bottom: 1rem;
    text-align: center;
  }
  .player-header {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .player-header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--accent), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
  }

  .injuries-section {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .section-title h2 {
    font-size: 1.75rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .injuries-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.02);
    font-size: 0.95rem;
  }

  .injuries-table thead {
    background: linear-gradient(135deg, #1e1e3f, #2a2a5a);
    color: white;
  }

  .injuries-table th {
    padding: 1.25rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .injuries-table td {
    padding: 1.25rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    vertical-align: middle;
  }

  .injuries-table tbody tr {
    transition: all 0.2s ease;
  }

  .injuries-table tbody tr:hover {
    background: rgba(79, 70, 229, 0.08);
    transform: translateX(4px);
  }

  .severity-badge {
    padding: 0.4rem 0.9rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .severity-minor {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border: 1px solid var(--success);
  }
  .severity-moderate {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
    border: 1px solid var(--warning);
  }
  .severity-severe {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border: 1px solid var(--danger);
  }

  .status-badge {
    padding: 0.3rem 0.7rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .status-open {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger);
  }
  .status-closed {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
  }

  .date {
    font-family: "SF Mono", Monaco, monospace;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .injury-type {
    font-weight: 500;
  }

  .injury-bodypart {
    font-size: 0.85rem;
    opacity: 0.8;
  }

  .reporter {
    font-weight: 500;
    color: var(--accent);
  }

  .action-btn {
    background: rgba(79, 70, 229, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(79, 70, 229, 0.3);
    border-radius: 10px;
    padding: 0.6rem 1.2rem;
    color: var(--accent);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .action-btn:hover {
    background: rgba(79, 70, 229, 0.25);
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  }

  .no-injuries {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
  }

  .no-injuries i {
    font-size: 5rem;
    opacity: 0.3;
    margin-bottom: 1.5rem;
    color: var(--text-secondary);
  }

  .no-injuries h3 {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .empty-state-gradient {
    background: linear-gradient(
      135deg,
      rgba(79, 70, 229, 0.1),
      rgba(34, 197, 94, 0.1)
    );
    border-radius: 16px;
    padding: 2rem;
    margin-top: 1.5rem;
    border: 1px solid var(--glass-border);
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    .injuries-table {
      font-size: 0.85rem;
    }
    .injuries-table th,
    .injuries-table td {
      padding: 0.75rem 0.5rem;
    }
  }
  .tests-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 24px;
    grid-auto-flow: row dense;
  }

  .test-card {
    background: #2b2b2b;
    border-radius: 8px;
    padding: 15px;
    color: #fff;
  }

  .test-card h3 {
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
    border-bottom: 3px solid #f39c12;
    padding-bottom: 6px;
  }

  .chart-wrapper {
    width: 100%;
    height: 280px;
  }

  .chart-wrapper canvas {
    width: 100% !important;
    height: 100% !important;
  }

  .stats-table {
    width: 100%;
    margin-top: 12px;
    border-collapse: collapse;
    background: #fff;
    color: #000;
    font-size: 12px;
  }

  .stats-table th {
    background: #e5e5e5;
    padding: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-weight: 600;
    color: #000;
  }

  .stats-table td {
    padding: 6px;
    border: 1px solid #ccc;
    text-align: center;
  }

  @media (max-width: 992px) {
    .tests-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="welcome-section">
  <h1>Welcome</h1>
</div>

<main class="main-card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="mb-0 fw-bold black-white">Player Records</h2>

    {% comment %}
    <div class="settings-section ms-auto">
      {% if has_session_settings %}
      <div class="report-settings-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="status-pill">‚öôÔ∏è Active</span>
          <a href="{% url 'delete_session' %}" class="clear-link">Clear</a>
        </div>

        <div class="settings-pills">
          <span class="pill pill-blue">
            Min/Max: {{ min_max_formula|title }}
          </span>
          <span class="pill pill-green">
            {{ min_is_better|yesno:"Min Better,Max Better" }}
          </span>
          <span class="pill pill-purple">
            Group: {{ grp_avg_option|default:"Standard"|title }}
          </span>
        </div>

        <a href="{% url 'report_settings' %}" class="settings-edit-link">
          Change in Report Settings
        </a>
      </div>
      {% else %}
      <a
        href="{% url 'report_settings' %}"
        class="btn btn-outline-light btn-sm"
      >
        ‚öôÔ∏è Configure Report Settings
      </a>
      {% endif %}
    </div>
    {% endcomment %}
  </div>

  <!-- Form -->
  <form class="form-container" method="post" action="{% url 'multitest' %}">
    {% csrf_token %}
    <div class="form-fields">
      <!-- DATE FILTER (Keep existing) -->
      <div class="date-filter-group">
        <label>Date Option:</label><br />
        <label
          ><input
            type="radio"
            id="range"
            name="date_option"
            value="range"
            onclick="toggleDateInputs('range')"
          />
          Start Date - End Date</label
        ><br />
        <label
          ><input
            type="radio"
            id="1month"
            name="date_option"
            value="1month"
            onclick="toggleDateInputs('preset')"
          />
          Last 1 Month</label
        ><br />
        <label
          ><input
            type="radio"
            id="3months"
            name="date_option"
            value="3months"
            onclick="toggleDateInputs('preset')"
          />
          Last 3 Months</label
        ><br />
        <label
          ><input
            type="radio"
            id="6months"
            name="date_option"
            value="6months"
            onclick="toggleDateInputs('preset')"
          />
          Last 6 Months</label
        ><br />
        <label
          ><input
            type="radio"
            id="fy"
            name="date_option"
            value="fy"
            onclick="toggleDateInputs('preset')"
          />
          Financial Year</label
        ><br />
        <div id="date-range-fields" style="display: none; margin-top: 12px">
          <label for="startDateInput">Start Date:</label>
          <input
            type="date"
            id="startDateInput"
            name="start_date"
            class="input"
            disabled
          />
          <label for="endDateInput">End Date:</label>
          <input
            type="date"
            id="endDateInput"
            name="end_date"
            class="input"
            disabled
          />
        </div>
      </div>

      <!-- MULTI TEST SELECTION -->
      <div class="select-wrapper">
        <label><strong>Select Tests:</strong></label>
        <div class="selected-count" id="selectedCount">0 Tests Selected</div>
        <div class="tests-grid" id="testsGrid">
          <div class="test-checkbox" data-test="10m">
            <input type="checkbox" name="tests" value="10m" id="test-10m" />
            <label for="test-10m" class="test-label">‚ö° 10m Sprint</label>
          </div>
          <div class="test-checkbox" data-test="20m">
            <input type="checkbox" name="tests" value="20m" id="test-20m" />
            <label for="test-20m" class="test-label">‚ö° 20m Sprint</label>
          </div>
          <div class="test-checkbox" data-test="YoYo">
            <input type="checkbox" name="tests" value="YoYo" id="test-yoyo" />
            <label for="test-yoyo" class="test-label">üèÉ YoYo Test</label>
          </div>
          <div class="test-checkbox" data-test="SBJ">
            <input type="checkbox" name="tests" value="SBJ" id="test-sbj" />
            <label for="test-sbj" class="test-label"
              >üìè Standing Broad Jump</label
            >
          </div>
          <div class="test-checkbox" data-test="Copenhagen">
            <input
              type="checkbox"
              name="tests"
              value="Copenhagen"
              id="test-copenhagen"
            />
            <label for="test-copenhagen" class="test-label"
              >ü¶ò Copen hagen</label
            >
          </div>
          <div class="test-checkbox" data-test="S/L Glute Bridges">
            <input
              type="checkbox"
              name="tests"
              value="S/L Glute Bridges"
              id="test-Glute-Bridges"
            />
            <label for="test-Glute-Bridges" class="test-label"
              >üí™ S/L Glute Bridges</label
            >
          </div>
        </div>
      </div>

      <!-- PLAYER & NUM TESTS -->
      <div style="display: flex; gap: 1rem">
        <div class="select-wrapper" style="flex: 1">
          <label for="playerSelect">Select Player:</label>
          <select id="playerSelect" name="player_id" class="input" required>
            <option value="" disabled selected>-- Select Player --</option>
            {% for p in players %}
            <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="select-wrapper" style="flex: 1">
          <label for="numTestsToShow">Show Last N Tests:</label>
          <select id="numTestsToShow" name="num_tests" class="input" required>
            <option value="" disabled selected>No Test available</option>
          </select>
        </div>
      </div>

      <div class="button-wrapper">
        <button
          type="submit"
          style="
            background: linear-gradient(
              135deg,
              var(--color-secondary),
              var(--color-accent)
            );
          "
        >
          üöÄ Fetch Multi Test Report
        </button>
      </div>
    </div>
  </form>
  <!-- Normal Test -->
  {% if error %}
  <p style="color: red">{{ error }}</p>
  {% endif %} {% if player_info %}
  <div id="playerInfoSection" class="player-info-section">
    <h3 class="player-info-title">
      Individual Report - {{ player_info.name }}
    </h3>
    <div class="player-info-card" id="playerInfoCard">
      <div class="player-photo">
        {% if player_info.image %}
        <img
          src="{{ player_info.image.url }}"
          alt="{{ player_info.name }}"
          style="max-width: 100%; max-height: 100%; object-fit: cover"
        />
        {% else %} No Image {% endif %}
      </div>
      <table class="player-info-table">
        <tr>
          <th>Name</th>
          <td>{{ player_info.name }}</td>
        </tr>
        <tr>
          <th>Age</th>
          <td>{{ player_info.age }}</td>
        </tr>
        <tr>
          <th>Gender</th>
          <td>{{ player_info.gender }}</td>
        </tr>
        <tr>
          <th>Role</th>
          <td>{{ player_info.role }}</td>
        </tr>
        <tr>
          <th>Handness</th>
          <td>{{ player_info.handedness }}</td>
        </tr>
        <tr>
          <th>Category</th>
          <td>{{ player_info.age_category }}</td>
        </tr>
        <tr>
          <th>Batting Style</th>
          <td>{{ player_info.batting_style }}</td>
        </tr>
        <tr>
          <th>Bowling Style</th>
          <td>{{ player_info.bowling_style }}</td>
        </tr>
        <tr>
          <th>Player Status</th>
          <td>{{ player_info.player_status }}</td>
        </tr>
      </table>
    </div>
  </div>
  {% endif %}

  <div class="tests-grid">
    <!-- 10m Test -->

    {% if test10 %}
    <div class="test-card">
      <h3>10m Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chart10m"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTable10m">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Distance Covered</th>
              <th>Predicted VO2max</th>
              <th>Best</th>
            </tr>
          </thead>
          <tbody>
            {% for row in test10 %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.distance_covered }}</td>
              <td>{{ row.predicted_vo2max }}</td>
              <td>{{ row.best }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}

    <!-- 20m Tests -->
    {% if test20 %}
    <div class="test-card">
      <h3>20m Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chart20m"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTable20m">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Distance Covered</th>
              <th>Predicted VO2max</th>
              <th>Best</th>
            </tr>
          </thead>
          <tbody>
            {% for row in test20 %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.distance_covered }}</td>
              <td>{{ row.predicted_vo2max }}</td>
              <td>{{ row.best }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}

    <!-- YoYo Tests -->
    {% if testYoYo %}

    <div class="test-card">
      <h3>Yoyo Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chartYoYo"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTableYoYo">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Distance Covered</th>
              <th>Predicted VO2max</th>
              <th>Best</th>
            </tr>
          </thead>
          <tbody>
            {% for row in testYoYo %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.distance_covered }}</td>
              <td>{{ row.predicted_vo2max }}</td>
              <td>{{ row.best }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}

    <!-- Standing Broad Jump Tests -->
    {% if testSBJ %}

    <div class="test-card">
      <h3>Standing Broad Jump Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chartSBJ"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTableSBJ">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Distance Covered</th>
              <th>Predicted VO2max</th>
              <th>Best</th>
            </tr>
          </thead>
          <tbody>
            {% for row in testSBJ %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.distance_covered }}</td>
              <td>{{ row.predicted_vo2max }}</td>
              <td>{{ row.best }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}

    <!-- Copenhagen Test s-->
    {% if testCopenhagen %}

    <div class="test-card">
      <h3>Copen Hagen Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chartCopenhagen"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTableCopenhagen">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Right</th>
              <th>Left</th>
              <th>Difference</th>
              <th>Ratio</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for row in testCopenhagen %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.right }}</td>
              <td>{{ row.left }}</td>
              <td>{{ row.difference }}</td>
              <td>{{ row.ratio }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.notes }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}

    <!-- Glute Bridges Test s-->
    {% if testGluteBridges %}

    <div class="test-card">
      <h3>S/L Glute Bridges Tests</h3>
      <div class="chart-wrapper">
        <canvas id="chartGlute"></canvas>
      </div>
      <div class="table-container" id="statsTableContainer">
        <table class="stats-table" id="statsTableGlute">
          <thead>
            <tr>
              <th>Date</th>
              <th>Phase</th>
              <th>Right</th>
              <th>Left</th>
              <th>Difference</th>
              <th>Ratio</th>
              <th>Gender</th>
              <th>Category</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for row in testGluteBridges %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.phase }}</td>
              <td>{{ row.right }}</td>
              <td>{{ row.left }}</td>
              <td>{{ row.difference }}</td>
              <td>{{ row.ratio }}</td>
              <td>{{ row.gender }}</td>
              <td>{{ row.category }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}
  </div>

  {% if total_injuries > 0 %}
  <!-- Player Header -->
  <div class="player-header">
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4"
    >
      <!-- Add player name/title here if needed -->
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="text-sm opacity-80 mb-2">Total Injuries</div>
        <div class="stat-number">{{ total_injuries }}</div>
      </div>
      <div class="stat-card">
        <div class="text-sm opacity-80 mb-2">Active (Open)</div>
        <div class="stat-number text-red-400">{{ open_injuries }}</div>
      </div>
      <div class="stat-card">
        <div class="text-sm opacity-80 mb-2">Recovered</div>
        <div class="stat-number text-green-400">{{ closed_injuries }}</div>
      </div>
    </div>
  </div>
  {% endif %} {% if injuries %}
  <!-- Injuries Table Section -->
  <section class="injuries-section">
    <div class="section-title">
      <h2>
        <i class="fas fa-clipboard-list text-2xl"></i>
        Injury History
      </h2>
    </div>

    <!-- FIXED: Proper table container with horizontal scroll -->
    <div class="table-container">
      <table class="injuries-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Injury Details</th>
            <th>Reported By</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Expected Return</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for injury in injuries %}
          <tr class="group">
            <td class="date font-mono">{{ injury.injury_date}}</td>
            <td>
              <div class="injury-type">
                {{ injury.name|default:injury.nature_of_injury }}
              </div>
              {% if injury.affected_body_part %}
              <div class="injury-bodypart">{{ injury.affected_body_part }}</div>
              {% endif %}
            </td>
            <td class="reporter">
              {% if injury.reported_by %} {{ injury.reported_by.name }} {% else
              %}
              <span class="opacity-70">Self-Reported</span>
              {% endif %}
            </td>
            <td>
              {% if injury.severity_rating %}
              <span
                class="severity-badge severity-{{ injury.severity|default:'minor' }}"
              >
                {{ injury.severity_rating }} {% if injury.severity_rating %} ({{
                injury.severity_rating }}/10){% endif %}
              </span>
              {% else %}
              <span class="text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              <span
                class="status-badge status-{{ injury.status|default:'open' }}"
              >
                {{ injury.get_status_display|default:injury.status|title }}
              </span>
            </td>
            <td class="date">
              {% if injury.expected_date_of_return %} {{
              injury.expected_date_of_return|date:"M d, Y" }} {% else %}
              <span class="opacity-60">Not Set</span>
              {% endif %}
            </td>
            <td>
              <a
                href="{% url 'organization_injury_detail' injury.pk %}"
                class="action-btn group-hover:scale-105"
                title="View {{ injury.name|default:'Injury' }} Details"
              >
                <i class="fas fa-eye"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-12 text-gray-400">
              <i class="fas fa-inbox text-4xl opacity-50 mb-4 block"></i>
              <div>No injury records found for this player</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}
</main>
<script>
  const FETCH_REPORT_URL = "{% url 'player_test_data' %}";

  // Multi-checkbox handler
  document.querySelectorAll(".test-checkbox").forEach((checkbox) => {
    checkbox.addEventListener("click", function (e) {
      if (e.target.tagName !== "INPUT") {
        const input = this.querySelector('input[type="checkbox"]');
        input.checked = !input.checked;
        this.classList.toggle("checked", input.checked);
        updateSelectedCount();
      }
    });
  });

  function updateSelectedCount() {
    const count = document.querySelectorAll(
      'input[name="tests"]:checked'
    ).length;
    document.getElementById(
      "selectedCount"
    ).textContent = `${count} Tests Selected${
      count > 0 ? ` (${count}/6)` : ""
    }`;
  }

  // Date toggle
  function toggleDateInputs(type) {
    const dateRangeFields = document.getElementById("date-range-fields");
    const startDateInput = document.getElementById("startDateInput");
    const endDateInput = document.getElementById("endDateInput");
    if (type === "range") {
      dateRangeFields.style.display = "block";
      startDateInput.disabled = false;
      endDateInput.disabled = false;
    } else {
      dateRangeFields.style.display = "none";
      startDateInput.disabled = true;
      endDateInput.disabled = true;
    }
  }

  // ‚≠ê FIXED: Dynamic dropdown handlers
  function setupDynamicDropdown() {
    document
      .getElementById("playerSelect")
      .addEventListener("change", handlePlayerChange);
    document.querySelectorAll('input[name="tests"]').forEach((checkbox) => {
      checkbox.addEventListener("change", handleTestChange);
    });
  }

  function handlePlayerChange() {
    console.log(
      "üéØ Player changed:",
      document.getElementById("playerSelect").value
    );
    updateTestDropdown();
  }

  function handleTestChange() {
    console.log("üéØ Tests changed:", getSelectedTests());
    updateTestDropdown();
  }

  function updateTestDropdown() {
    const playerId = document.getElementById("playerSelect").value;
    if (playerId && getSelectedTests().length > 0) {
      updateNumTestsOptions(playerId);
    } else {
      showNoTestsMessage();
    }
  }

  function getSelectedTests() {
    return Array.from(
      document.querySelectorAll('input[name="tests"]:checked')
    ).map((cb) => cb.value);
  }

  // ‚≠ê UPDATED: Show "No tests" message when no data
  async function updateNumTestsOptions(playerId) {
    const selectedTests = getSelectedTests();

    if (selectedTests.length === 0) {
      console.log("‚ùå No tests selected");
      showNoTestsMessage();
      return;
    }

    console.log(
      "üîÑ Fetching test counts for:",
      selectedTests,
      "Player:",
      playerId
    );

    const formData = new FormData();
    formData.append("player_id", playerId);
    formData.append("tests", selectedTests.join(","));
    formData.append("action", "preview_test_counts");

    try {
      const response = await fetch(FETCH_REPORT_URL, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        credentials: "same-origin",
      });

      const data = await response.json();
      console.log("üìä Test count response:", data);

      if (data.success) {
        if (data.max_tests && data.max_tests > 0) {
          populateNumTestsOptions(data.max_tests);
        } else {
          showNoTestsMessage(
            data.message || "No test data found for selected tests"
          );
        }
      } else {
        showNoTestsMessage("Error loading test data");
      }
    } catch (error) {
      console.error("‚ùå Error:", error);
      showNoTestsMessage("Failed to load test data");
    }
  }

  // ‚≠ê NEW: Show "No tests available" message
  function showNoTestsMessage(message = "No tests available") {
    const numTestsSelect = document.getElementById("numTestsToShow");
    numTestsSelect.innerHTML = `
            <option value="" disabled selected style="color: #ff6b6b;">‚ùå ${message}</option>
        `;
    console.log("üìã Showing no tests message:", message);
  }

  // Populate N tests dropdown based on available tests
  function populateNumTestsOptions(maxTests) {
    const numTestsSelect = document.getElementById("numTestsToShow");
    numTestsSelect.innerHTML =
      '<option value="" disabled selected>-- Select --</option>';

    const maxOption = Math.min(maxTests, 10);

    for (let i = 1; i <= maxOption; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${i} Test${i > 1 ? "s" : ""}`;
      numTestsSelect.appendChild(option);
    }

    // Auto-select reasonable default
    if (maxOption >= 3) {
      numTestsSelect.value = "3";
    } else if (maxOption > 0) {
      numTestsSelect.value = maxOption.toString();
    }

    console.log("‚úÖ Dropdown updated with max:", maxTests);
  }

  // Reset dropdown (no longer used - replaced by showNoTestsMessage)
  function resetNumTestsOptions() {
    showNoTestsMessage("Please select tests first");
  }

  // ‚≠ê MAIN FUNCTION: Fetch Multi Test Report (unchanged)
  async function fetchMultiTestReport() {
    const selectedTests = getSelectedTests();
    const playerId = document.getElementById("playerSelect").value;
    const numTests = document.getElementById("numTestsToShow").value;
    const dateOption = document.querySelector(
      'input[name="date_option"]:checked'
    )?.value;

    if (selectedTests.length === 0) {
      alert("‚ö†Ô∏è Please select at least one test");
      return;
    }
    if (!playerId) {
      alert("‚ö†Ô∏è Please select a player");
      return;
    }
    if (!numTests || numTests === "") {
      alert("‚ö†Ô∏è No tests available for this player");
      return;
    }

    let startDate = "",
      endDate = "";
    if (dateOption === "range") {
      startDate = document.getElementById("startDateInput").value;
      endDate = document.getElementById("endDateInput").value;
      if (!startDate || !endDate) {
        alert("‚ö†Ô∏è Please select start and end dates");
        return;
      }
    }

    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Loading...";
    submitBtn.disabled = true;

    const formData = new FormData();
    formData.append("tests", selectedTests.join(","));
    formData.append("player_id", playerId);
    formData.append("num_tests", numTests);
    formData.append("date_option", dateOption);
    formData.append("start_date", startDate);
    formData.append("end_date", endDate);

    try {
      const response = await fetch(FETCH_REPORT_URL, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        credentials: "same-origin",
      });

      const data = await response.json();
      if (data.success) {
        displayMultiTestResults(data);
      } else {
        alert("Error: " + (data.error || "Unknown error"));
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to fetch report");
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }

  // [Keep your existing displayMultiTestResults, renderTestTable, getCookie functions]
  function displayMultiTestResults(data) {
    /* your code */
  }
  function renderTestTable(testName, data, isAsymmetry = false) {
    /* your code */
  }
  function getCookie(name) {
    /* your code */
  }

  // ‚≠ê CRITICAL INITIALIZATION
  document.addEventListener("DOMContentLoaded", function () {
    setupDynamicDropdown();
    updateSelectedCount();
    showNoTestsMessage("Select tests & player to see available tests");
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const testCharts = [
      {
        tableId: "statsTable10m",
        canvasId: "chart10m",
        label: "10m Test Best",
        type: "single",
      },
      {
        tableId: "statsTable20m",
        canvasId: "chart20m",
        label: "20m Test Best",
        type: "single",
      },
      {
        tableId: "statsTableYoYo",
        canvasId: "chartYoYo",
        label: "YoYo Test Best",
        type: "single",
      },
      {
        tableId: "statsTableSBJ",
        canvasId: "chartSBJ",
        label: "SBJ Test Best",
        type: "single",
      },
      {
        tableId: "statsTableGlute",
        canvasId: "chartGlute",
        label: "Glute Bridges",
        type: "dual",
      },
      {
        tableId: "statsTableCopenhagen",
        canvasId: "chartCopenhagen",
        label: "Copenhagen Test",
        type: "dual",
      },
    ];

    testCharts.forEach((test) => {
      const table = document.getElementById(test.tableId);
      const canvas = document.getElementById(test.canvasId);

      if (!table || !canvas) {
        console.warn(`Table or canvas not found for ${test.tableId}`);
        return;
      }

      const rows = Array.from(table.querySelectorAll("tbody tr"));

      if (rows.length === 0) return;

      canvas.parentElement.style.height = "400px";

      if (test.type === "single") {
        const labels = rows.map((row) => {
          const cells = row.querySelectorAll("td");
          return `${cells[0]?.textContent.trim()} (${cells[1]?.textContent.trim()})`;
        });
        const bestValues = rows.map((row) =>
          parseFloat(row.querySelectorAll("td")[6]?.textContent.trim())
        );

        new Chart(canvas.getContext("2d"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: test.label,
                data: bestValues,
                backgroundColor: "#007CF0",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              title: { display: true, text: test.label },
            },
            scales: {
              x: {
                title: { display: true, text: "Date (Phase)" },
                ticks: { autoSkip: false },
              },
              y: {
                title: { display: true, text: "Best Value" },
                beginAtZero: true,
              },
            },
          },
        });
      }

      if (test.type === "dual") {
        const labels = rows.map((row) => {
          const cells = row.querySelectorAll("td");
          return `${cells[0]?.textContent.trim()} (${cells[1]?.textContent.trim()})`;
        });

        const leftValues = rows.map((row) =>
          parseFloat(row.querySelectorAll("td")[3]?.textContent.trim())
        );
        const rightValues = rows.map((row) =>
          parseFloat(row.querySelectorAll("td")[2]?.textContent.trim())
        );

        new Chart(canvas.getContext("2d"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Left",
                data: leftValues,
                backgroundColor: "#10b981",
                barThickness: 28,
              },
              {
                label: "Right",
                data: rightValues,
                backgroundColor: "#3b82f6",
                barThickness: 28,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Date / Phase",
                },
                ticks: {
                  padding: 8,
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Score",
                },
              },
            },
          },
        });
      }
    });
  });
</script>

{% endblock%}
